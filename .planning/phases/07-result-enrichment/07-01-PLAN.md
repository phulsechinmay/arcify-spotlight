---
phase: 07-result-enrichment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/data-providers/base-data-provider.js
  - shared/ui-utilities.js
autonomous: true

must_haves:
  truths:
    - "Arcify-bookmarked tab shows 'Open Pinned Tab' action"
    - "Chrome-pinned Arcify tab shows 'Open Favorite Tab' action"
    - "Non-Arcify tabs show existing wording unchanged ('Switch to Tab' or enter symbol)"
  artifacts:
    - path: "shared/data-providers/base-data-provider.js"
      provides: "enrichWithArcifyInfo() method and pipeline integration"
      contains: "enrichWithArcifyInfo"
    - path: "shared/ui-utilities.js"
      provides: "Conditional action text in formatResult()"
      contains: "Open Pinned Tab"
  key_links:
    - from: "shared/data-providers/base-data-provider.js"
      to: "shared/data-providers/arcify-provider.js"
      via: "dynamic import and getSpaceForUrl() call"
      pattern: "arcifyProvider\\.getSpaceForUrl"
    - from: "shared/ui-utilities.js"
      to: "result.metadata.isArcify"
      via: "conditional check in formatResult()"
      pattern: "metadata\\?\\.isArcify"
---

<objective>
Enrich search results with Arcify metadata and update action text wording

Purpose: Bridge Phase 6 detection layer with UI by injecting space metadata into results, then customize action text based on Arcify status. Users will see "Open Pinned Tab" for Arcify-bookmarked tabs and "Open Favorite Tab" for Chrome-pinned Arcify tabs.

Output: Modified BaseDataProvider with enrichment pipeline stage, modified SpotlightUtils.formatResult() with conditional action text
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-detection-cache/06-01-SUMMARY.md
@.planning/phases/07-result-enrichment/07-RESEARCH.md

# Source files to modify
@shared/data-providers/base-data-provider.js
@shared/ui-utilities.js
@shared/data-providers/arcify-provider.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enrichWithArcifyInfo() method to BaseDataProvider</name>
  <files>shared/data-providers/base-data-provider.js</files>
  <action>
Add a new async method `enrichWithArcifyInfo(results)` to BaseDataProvider class after the `deduplicateResults()` method (around line 506).

Implementation:
1. Lazy-load arcifyProvider via dynamic import to avoid circular dependencies:
   ```javascript
   if (!this.arcifyProvider) {
       const { arcifyProvider } = await import('./arcify-provider.js');
       this.arcifyProvider = arcifyProvider;
   }
   ```

2. Iterate over results with a for...of loop (serial is fine, O(1) lookups are fast)

3. For each result:
   - Skip if no URL: `if (!result.url) continue;`
   - Skip if already has space info (pinned tabs): `if (result.metadata?.spaceName) continue;`
   - Call O(1) lookup: `const spaceInfo = await this.arcifyProvider.getSpaceForUrl(result.url);`
   - If spaceInfo exists, inject metadata:
     ```javascript
     result.metadata = result.metadata || {};
     result.metadata.isArcify = true;
     result.metadata.spaceName = spaceInfo.spaceName;
     result.metadata.spaceColor = spaceInfo.spaceColor;
     result.metadata.spaceId = spaceInfo.spaceId;
     result.metadata.bookmarkId = spaceInfo.bookmarkId;
     result.metadata.bookmarkTitle = spaceInfo.bookmarkTitle;
     ```

4. Return the same results array (mutation in place is safe here)

Add JSDoc comment explaining the method purpose, when it's called (after deduplication), and that null spaceInfo means "not in Arcify folder" (not an error).

IMPORTANT: Do NOT throw errors when spaceInfo is null - this is the expected case for non-Arcify URLs.
  </action>
  <verify>
File compiles without errors: `npm run build` succeeds with no import/export errors.
Method exists and has correct signature by grepping: `grep -n "enrichWithArcifyInfo" shared/data-providers/base-data-provider.js`
  </verify>
  <done>enrichWithArcifyInfo() method exists in BaseDataProvider with lazy arcifyProvider import, result iteration, skip logic for no-URL and already-enriched results, O(1) lookup, and metadata injection</done>
</task>

<task type="auto">
  <name>Task 2: Integrate enrichment into getSpotlightSuggestions() pipeline</name>
  <files>shared/data-providers/base-data-provider.js</files>
  <action>
Modify the `getSpotlightSuggestions()` method to call enrichment AFTER deduplication but BEFORE scoring.

Find the section (around lines 127-131):
```javascript
// Apply comprehensive deduplication across all sources
const deduplicatedResults = this.deduplicateResults(allResults);

// Score and sort results
const finalResults = this.scoreAndSortResults(deduplicatedResults, trimmedQuery);
```

Change to:
```javascript
// Apply comprehensive deduplication across all sources
const deduplicatedResults = this.deduplicateResults(allResults);

// Enrich with Arcify space info (after dedup to avoid redundant lookups)
const enrichedResults = await this.enrichWithArcifyInfo(deduplicatedResults);

// Score and sort results
const finalResults = this.scoreAndSortResults(enrichedResults, trimmedQuery);
```

This ensures:
1. Deduplication happens first (prevents N lookups for same URL)
2. Enrichment injects metadata before scoring (enables future space-aware scoring)
3. Scoring operates on enriched results
  </action>
  <verify>
Verify the pipeline order by checking line sequence: `grep -n -A2 "deduplicateResults\|enrichWithArcifyInfo\|scoreAndSortResults" shared/data-providers/base-data-provider.js`
Order must be: deduplicateResults -> enrichWithArcifyInfo -> scoreAndSortResults
  </verify>
  <done>getSpotlightSuggestions() calls enrichWithArcifyInfo() after deduplication and before scoring</done>
</task>

<task type="auto">
  <name>Task 3: Update formatResult() for conditional action text</name>
  <files>shared/ui-utilities.js</files>
  <action>
Modify `SpotlightUtils.formatResult()` method (lines 169-220) to check `result.metadata?.isArcify` and customize action text.

Update the OPEN_TAB formatter (around line 186-189):
```javascript
[ResultType.OPEN_TAB]: {
    title: result.title,
    subtitle: result.domain,
    action: mode === SpotlightTabMode.NEW_TAB
        ? 'Switch to Tab'
        : (result.metadata?.isArcify ? 'Open Pinned Tab' : '↵')
},
```

Update the PINNED_TAB formatter (around line 191-194):
```javascript
[ResultType.PINNED_TAB]: {
    title: result.title,
    subtitle: result.domain,
    action: result.metadata?.isActive
        ? 'Switch to Tab'
        : (result.metadata?.isArcify ? 'Open Favorite Tab' : 'Open Pinned Tab')
},
```

Logic explanation:
- OPEN_TAB + isArcify: "Open Pinned Tab" (user has this tab bookmarked in Arcify)
- OPEN_TAB + not isArcify: "↵" (regular tab, enter to switch)
- PINNED_TAB + isActive: "Switch to Tab" (tab is already open)
- PINNED_TAB + isArcify + not isActive: "Open Favorite Tab" (Chrome-pinned AND in Arcify)
- PINNED_TAB + not isArcify + not isActive: "Open Pinned Tab" (just Chrome-pinned)

IMPORTANT: Use optional chaining (`?.`) to prevent errors when metadata is undefined.
Do NOT modify BOOKMARK, HISTORY, TOP_SITE, or other result types - they should keep existing "↵" action.
  </action>
  <verify>
Verify action text strings exist: `grep -n "Open Pinned Tab\|Open Favorite Tab" shared/ui-utilities.js`
Verify optional chaining used: `grep -n "metadata?.isArcify\|metadata?.isActive" shared/ui-utilities.js`
Build succeeds: `npm run build`
  </verify>
  <done>formatResult() returns "Open Pinned Tab" for Arcify-bookmarked tabs, "Open Favorite Tab" for Chrome-pinned Arcify tabs, and unchanged wording for non-Arcify results</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   npm run build
   ```
   Must complete with no errors.

2. **Code structure verification:**
   ```bash
   # Enrichment method exists
   grep -n "async enrichWithArcifyInfo" shared/data-providers/base-data-provider.js

   # Pipeline order correct
   grep -n "deduplicatedResults\|enrichedResults\|finalResults" shared/data-providers/base-data-provider.js

   # Action text updated
   grep -n "Open Pinned Tab\|Open Favorite Tab" shared/ui-utilities.js
   ```

3. **Manual verification (after loading extension):**
   - Open a tab that IS in Arcify bookmarks
   - Open Spotlight, search for that tab
   - Verify action shows "Open Pinned Tab"
   - For a Chrome-pinned tab that's also in Arcify, verify "Open Favorite Tab"
   - For a regular tab not in Arcify, verify "↵" or "Switch to Tab"
</verification>

<success_criteria>
- [x] enrichWithArcifyInfo() method added to BaseDataProvider
- [x] Method called in pipeline after deduplication, before scoring
- [x] formatResult() returns correct action text based on isArcify flag
- [x] Non-Arcify results unaffected (existing wording preserved)
- [x] Build passes with no errors
- [x] Optional chaining prevents undefined errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-result-enrichment/07-01-SUMMARY.md`
</output>
