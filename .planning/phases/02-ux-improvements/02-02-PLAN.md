---
phase: 02-ux-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - manifest.json
  - background.js
  - shared/ui-utilities.js
autonomous: true

must_haves:
  truths:
    - "User sees highlight color matching their active tab group color"
    - "User sees purple highlight when not in any tab group"
    - "User sees correct color for all Chrome tab group colors including orange"
  artifacts:
    - path: "manifest.json"
      provides: "tabGroups permission"
      contains: "tabGroups"
    - path: "background.js"
      provides: "Direct Tab Groups API color fetch"
      contains: "chrome.tabGroups.get"
    - path: "shared/ui-utilities.js"
      provides: "Orange color in color map"
      contains: "orange:"
  key_links:
    - from: "background.js"
      to: "chrome.tabGroups.get()"
      via: "API call"
      pattern: "chrome\\.tabGroups\\.get\\(activeTab\\.groupId\\)"
    - from: "shared/ui-utilities.js"
      to: "CSS variables"
      via: "color map lookup"
      pattern: "defaultColorMap\\[spaceColor\\]"
---

<objective>
Implement tab group color theming for spotlight highlights.

Purpose: Match spotlight highlight color to active tab group color for visual consistency with Chrome's native UI (UX-03).
Output: Updated manifest with tabGroups permission, background.js using Tab Groups API directly, ui-utilities.js with orange color support.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ux-improvements/RESEARCH.md

@manifest.json
@background.js
@shared/ui-utilities.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tabGroups permission to manifest</name>
  <files>manifest.json</files>
  <action>
Add `"tabGroups"` to the permissions array in manifest.json.

Current permissions array (line 6-16):
```json
"permissions": [
  "tabs",
  "storage",
  "bookmarks",
  "commands",
  "favicon",
  "scripting",
  "search",
  "topSites",
  "history"
]
```

Updated permissions array:
```json
"permissions": [
  "tabs",
  "tabGroups",
  "storage",
  "bookmarks",
  "commands",
  "favicon",
  "scripting",
  "search",
  "topSites",
  "history"
]
```

Place `tabGroups` after `tabs` for logical grouping (both are tab-related permissions).
  </action>
  <verify>
1. `npm run build` succeeds
2. JSON is valid (no syntax errors)
3. Load extension in chrome://extensions - no permission errors
  </verify>
  <done>
manifest.json includes tabGroups permission, extension loads without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update color handler to use Tab Groups API directly</name>
  <files>background.js, shared/ui-utilities.js</files>
  <action>
**In background.js:**

Find the `getActiveSpaceColor` message handler (around line 302-327) and replace it with direct Tab Groups API usage:

Replace this block:
```javascript
} else if (message.action === 'getActiveSpaceColor') {
    (async () => {
        try {
            const spacesResult = await chrome.storage.local.get('spaces');
            const spaces = spacesResult.spaces || [];

            const [activeTab] = await chrome.tabs.query({ active: true, currentWindow: true });

            if (!activeTab || !activeTab.groupId || activeTab.groupId === chrome.tabGroups.TAB_GROUP_ID_NONE) {
                sendResponse({ success: true, color: 'purple' });
                return;
            }

            const activeSpace = spaces.find(space => space.id === activeTab.groupId);

            if (activeSpace && activeSpace.color) {
                sendResponse({ success: true, color: activeSpace.color });
            } else {
                sendResponse({ success: true, color: 'purple' });
            }
        } catch (error) {
            Logger.error('[Background] Error getting active space color:', error);
            sendResponse({ success: false, error: error.message, color: 'purple' });
        }
    })();
    return true;
}
```

With:
```javascript
} else if (message.action === 'getActiveSpaceColor') {
    (async () => {
        try {
            const [activeTab] = await chrome.tabs.query({ active: true, currentWindow: true });

            // Check if tab exists and is in a group
            if (!activeTab || !activeTab.groupId || activeTab.groupId === chrome.tabGroups.TAB_GROUP_ID_NONE) {
                sendResponse({ success: true, color: 'purple' });
                return;
            }

            // Fetch color directly from Tab Groups API
            try {
                const group = await chrome.tabGroups.get(activeTab.groupId);
                sendResponse({ success: true, color: group.color || 'purple' });
            } catch (groupError) {
                // Group may have been closed or API unavailable
                Logger.error('[Background] Error fetching tab group:', groupError);
                sendResponse({ success: true, color: 'purple' });
            }
        } catch (error) {
            Logger.error('[Background] Error getting active space color:', error);
            sendResponse({ success: false, error: error.message, color: 'purple' });
        }
    })();
    return true;
}
```

Key changes:
- Remove `chrome.storage.local.get('spaces')` lookup
- Use `chrome.tabGroups.get(activeTab.groupId)` directly
- Return `group.color` from the API response
- Keep purple fallback for ungrouped tabs and errors

**In shared/ui-utilities.js:**

Find `getAccentColorCSS` method (around line 230) and add `orange` to the defaultColorMap:

Current colorMap (lines 232-241):
```javascript
const defaultColorMap = {
    grey: '204, 204, 204',
    blue: '139, 179, 243',
    red: '255, 158, 151',
    yellow: '255, 226, 159',
    green: '139, 218, 153',
    pink: '251, 170, 215',
    purple: '214, 166, 255',
    cyan: '165, 226, 234'
};
```

Updated colorMap:
```javascript
const defaultColorMap = {
    grey: '204, 204, 204',
    blue: '139, 179, 243',
    red: '255, 158, 151',
    yellow: '255, 226, 159',
    green: '139, 218, 153',
    pink: '251, 170, 215',
    purple: '214, 166, 255',
    cyan: '165, 226, 234',
    orange: '255, 176, 103'
};
```

This completes the Chrome Tab Groups color enum: grey, blue, red, yellow, green, pink, purple, cyan, orange.
  </action>
  <verify>
1. `npm run build` succeeds
2. Load extension in Chrome
3. Create a tab group with a specific color (e.g., blue)
4. Open spotlight (Alt+L) while in that tab group
5. Verify highlight color matches tab group color (blue highlights)
6. Move tab out of group or close group
7. Open spotlight again - verify purple (default) highlights
8. Test with orange tab group to verify new color works
  </verify>
  <done>
- Tab group color fetched directly from Chrome Tab Groups API
- No dependency on chrome.storage.local for color
- Orange color supported in color map
- Purple fallback works for ungrouped tabs
- Error handling gracefully falls back to purple
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Build extension: `npm run build`
2. Load unpacked extension in chrome://extensions
3. Test tab group colors:
   - Create tab group, set to blue -> open spotlight -> blue highlights
   - Change group to red -> reopen spotlight -> red highlights
   - Change group to orange -> reopen spotlight -> orange highlights
   - Remove tab from group -> reopen spotlight -> purple highlights
4. Test ungrouped tabs:
   - Open new tab (not in group) -> spotlight shows purple
5. Test edge cases:
   - Close tab group while spotlight open -> no crash
   - Open spotlight immediately after creating group -> correct color
</verification>

<success_criteria>
- UX-03: Highlight color matches active tab group color
- Purple fallback when tab is not in any group
- All 9 Chrome tab group colors work (grey, blue, red, yellow, green, pink, purple, cyan, orange)
- No errors in console when fetching color
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-improvements/02-02-SUMMARY.md`
</output>
