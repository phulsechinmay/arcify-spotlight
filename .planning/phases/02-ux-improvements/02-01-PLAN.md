---
phase: 02-ux-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/selection-manager.js
  - overlay.js
  - newtab.js
autonomous: true

must_haves:
  truths:
    - "User sees URL preview update when navigating suggestions with arrow keys"
    - "User sees URL preview for first suggestion on initial load"
    - "User sees at least 6 suggestions visible without scrolling"
  artifacts:
    - path: "shared/selection-manager.js"
      provides: "Selection change callback support"
      contains: "onSelectionChange"
    - path: "overlay.js"
      provides: "URL preview handler + denser CSS"
      contains: "handleSelectionChange"
    - path: "newtab.js"
      provides: "Denser CSS matching overlay"
      contains: "max-height: 288px"
  key_links:
    - from: "shared/selection-manager.js"
      to: "overlay.js"
      via: "callback invocation"
      pattern: "onSelectionChange.*getSelectedResult"
    - from: "overlay.js"
      to: "input.placeholder"
      via: "URL preview update"
      pattern: "input.placeholder.*result.url"
---

<objective>
Add URL preview on keyboard navigation and increase suggestion list density.

Purpose: Improve visual feedback during keyboard navigation (UX-01) and fit more suggestions on screen (UX-02).
Output: Modified SelectionManager with callback support, updated overlay.js and newtab.js with denser CSS and URL preview handler.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ux-improvements/RESEARCH.md

@shared/selection-manager.js
@overlay.js
@newtab.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection change callback to SelectionManager</name>
  <files>shared/selection-manager.js</files>
  <action>
Modify SelectionManager class to support an optional callback for selection changes:

1. Update constructor to accept optional `onSelectionChange` callback parameter:
   ```javascript
   constructor(container, onSelectionChange = null) {
       this.container = container;
       this.selectedIndex = 0;
       this.results = [];
       this.onSelectionChange = onSelectionChange;
   }
   ```

2. Update `updateResults()` to trigger callback for initial selection:
   ```javascript
   updateResults(newResults) {
       this.results = newResults;
       this.selectedIndex = 0;
       this.updateVisualSelection();

       // Trigger callback for initial selection
       if (this.onSelectionChange && this.results.length > 0) {
           this.onSelectionChange(this.getSelectedResult(), this.selectedIndex);
       }
   }
   ```

3. Update `moveSelection()` to trigger callback when selection changes:
   ```javascript
   moveSelection(direction) {
       const oldIndex = this.selectedIndex;
       const maxIndex = this.results.length - 1;

       if (direction === 'down') {
           this.selectedIndex = Math.min(this.selectedIndex + 1, maxIndex);
       } else if (direction === 'up') {
           this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
       }

       this.updateVisualSelection();

       // Notify callback if selection changed
       if (this.onSelectionChange && oldIndex !== this.selectedIndex) {
           this.onSelectionChange(this.getSelectedResult(), this.selectedIndex);
       }
   }
   ```

4. Update `moveToFirst()` and `moveToLast()` to also trigger callback:
   - Track old index before change
   - Call callback if index changed

Keep backward compatibility: existing code passing only `container` should continue working.
  </action>
  <verify>
Run `npm run build` to verify no syntax errors. Check that SelectionManager still exports correctly.
  </verify>
  <done>
SelectionManager accepts optional callback, invokes it on initial load and navigation changes. Existing consumers (newtab.js without callback) continue working.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire URL preview in overlay.js and apply density CSS</name>
  <files>overlay.js, newtab.js</files>
  <action>
**In overlay.js:**

1. Create URL preview handler function before SelectionManager instantiation (around line 380):
   ```javascript
   // URL preview callback - updates input placeholder with selected result URL
   const handleSelectionChange = (result, index) => {
       if (result && result.url) {
           input.placeholder = result.url;
       } else if (result && result.title) {
           input.placeholder = result.title;
       } else {
           // Reset to default placeholder
           input.placeholder = spotlightTabMode === SpotlightTabMode.NEW_TAB
               ? 'Search or enter URL (opens in new tab)...'
               : 'Search or enter URL...';
       }
   };
   ```

2. Update SelectionManager instantiation to pass the callback:
   ```javascript
   const selectionManager = new SelectionManager(resultsContainer, handleSelectionChange);
   ```

3. Update CSS density values in the inline CSS block (around lines 196-260):
   - `.arcify-spotlight-results`: Change `max-height: 270px` to `max-height: 288px`, change `padding: 8px 0` to `padding: 4px 0`
   - `.arcify-spotlight-result-item`: Change `padding: 12px 24px 12px 20px` to `padding: 8px 20px 8px 16px`, change `min-height: 44px` to `min-height: 40px`
   - `.arcify-spotlight-result-content`: Change `min-height: 32px` to `min-height: 24px`
   - `.arcify-spotlight-result-title`: Change `margin: 0 0 2px 0` to `margin: 0 0 1px 0`

**In newtab.js:**

1. Apply the same CSS density changes to match overlay.js (around lines 116-175):
   - Same values as overlay.js for consistency

newtab.js does NOT need the URL preview callback since its placeholder is static ("Search or enter URL (opens in new tab)...").
  </action>
  <verify>
1. `npm run build` succeeds
2. Load extension in Chrome
3. Open spotlight overlay (Alt+L)
4. Press Down arrow - input placeholder should update to show selected item's URL
5. Navigate through suggestions - placeholder updates for each selection
6. Count visible suggestions without scrolling - should be 6+
7. Open new tab page - verify same density (visual consistency)
  </verify>
  <done>
- URL preview updates in input placeholder when navigating with arrow keys in overlay
- Initial selection shows URL preview on first load
- At least 6 suggestions visible without scrolling in both overlay and new tab
- Density consistent between overlay and new tab page
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Build extension: `npm run build`
2. Load unpacked extension in chrome://extensions
3. Test overlay (Alt+L on any page):
   - Arrow down through suggestions - placeholder shows each URL
   - First item shows URL on initial load
   - Count 6+ visible suggestions
4. Test new tab page:
   - Same density as overlay
   - 6+ visible suggestions
5. Visual comparison: overlay and new tab should have matching item heights
</verification>

<success_criteria>
- UX-01: URL bar updates to show selected suggestion URL when navigating with keyboard
- UX-02: At least 6 suggestions visible without scrolling
- No regression in existing functionality (selection, navigation, result actions)
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-improvements/02-01-SUMMARY.md`
</output>
