---
phase: 09-fuse.js-matching-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - shared/fuse-search-service.js
  - shared/data-providers/background-data-provider.js
autonomous: true

must_haves:
  truths:
    - "Fuse.js is installed as a runtime dependency"
    - "A shared FuseSearchService module provides consistent Fuse config for all data sources"
    - "Open tabs are filtered using Fuse.js fuzzy matching instead of hand-rolled fuzzyMatch()"
    - "Pinned tabs are filtered using Fuse.js fuzzy matching instead of hand-rolled fuzzyMatch()"
    - "Tab search results include a matchScore property (0-1, where 1=perfect)"
  artifacts:
    - path: "shared/fuse-search-service.js"
      provides: "Centralized Fuse.js wrapper with shared config"
      exports: ["FuseSearchService"]
    - path: "shared/data-providers/background-data-provider.js"
      provides: "Tab and pinned tab data with Fuse.js matching"
      contains: "FuseSearchService"
  key_links:
    - from: "shared/fuse-search-service.js"
      to: "fuse.js"
      via: "import Fuse from 'fuse.js'"
      pattern: "import Fuse from"
    - from: "shared/data-providers/background-data-provider.js"
      to: "shared/fuse-search-service.js"
      via: "import and usage in getOpenTabsData and getPinnedTabsData"
      pattern: "FuseSearchService\\.search"
---

<objective>
Install Fuse.js, create the shared FuseSearchService wrapper, and migrate tab + pinned tab matching from hand-rolled fuzzyMatch() to Fuse.js.

Purpose: Establish the Fuse.js foundation that all subsequent data source migrations will use, and prove the pattern works by migrating the simplest data sources (tabs).
Output: fuse.js installed, FuseSearchService module created, tabs and pinned tabs using Fuse.js for matching with match quality scores.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-fuse.js-matching-engine/09-RESEARCH.md

Key source files:
@shared/data-providers/background-data-provider.js
@shared/data-providers/base-data-provider.js
@shared/search-types.js
@shared/scoring-constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fuse.js and create FuseSearchService</name>
  <files>
    package.json
    shared/fuse-search-service.js (NEW)
  </files>
  <action>
    1. Install Fuse.js as a runtime dependency:
       ```
       npm install fuse.js
       ```
       This should install v7.1.0+ and add it to `dependencies` (not devDependencies) in package.json.

    2. Create `shared/fuse-search-service.js` with the following:
       - Import Fuse from 'fuse.js'
       - Define a `FUSE_DEFAULT_OPTIONS` constant with:
         - threshold: 0.4
         - ignoreLocation: true (CRITICAL for URL matching -- see research Pitfall 2)
         - includeScore: true (REQUIRED for MATCH-04)
         - isCaseSensitive: false
         - minMatchCharLength: 2
         - shouldSort: true
         - findAllMatches: false
         - fieldNormWeight: 1
       - Export `FuseSearchService` class with a static `search(items, query, optionOverrides = {})` method:
         - Return empty array if !items, items.length === 0, or !query
         - Merge FUSE_DEFAULT_OPTIONS with optionOverrides (spread, overrides win)
         - Create new Fuse(items, mergedOptions)
         - Call fuse.search(query)
         - Map results to: `{ item: result.item, matchScore: 1 - result.score }` (score inversion -- Fuse 0=perfect, we want 1=perfect)
         - Return the mapped array
       - Also export `FUSE_DEFAULT_OPTIONS` for test access

    IMPORTANT: Do NOT add `keys` to FUSE_DEFAULT_OPTIONS. The `keys` config varies per data source (tabs use title/url, popular sites use displayName/domain). Each caller passes keys via optionOverrides.
  </action>
  <verify>
    - `npm ls fuse.js` shows fuse.js installed
    - `node -e "import('./shared/fuse-search-service.js').then(m => console.log(typeof m.FuseSearchService.search))"` prints "function" (may need --experimental-vm-modules or similar -- alternatively just verify the file exists and has correct exports by reading it)
    - package.json has `"fuse.js"` in `dependencies` (not devDependencies)
  </verify>
  <done>
    Fuse.js is installed. FuseSearchService exists at shared/fuse-search-service.js with a static search() method that accepts items, query, and option overrides, and returns results with inverted scores (1=perfect match).
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate tab matching to Fuse.js</name>
  <files>shared/data-providers/background-data-provider.js</files>
  <action>
    Modify `getOpenTabsData(query)` in background-data-provider.js:

    1. Add import at top: `import { FuseSearchService } from '../fuse-search-service.js';`

    2. In getOpenTabsData, replace the filtering logic. Currently (lines 33-45):
       ```js
       const filteredTabs = tabs.filter(tab => {
           if (!tab.title || !tab.url) return false;
           if (!query) return true;
           const queryLower = query.toLowerCase();
           const titleLower = tab.title.toLowerCase();
           const urlLower = tab.url.toLowerCase();
           return this.fuzzyMatch(queryLower, titleLower) ||
                  this.fuzzyMatch(queryLower, urlLower);
       })
       ```

       Replace with:
       ```js
       // Filter out tabs without required fields
       const validTabs = tabs.filter(tab => tab.title && tab.url);

       // No query = return all valid tabs
       if (!query) {
           return validTabs.map(tab => {
               const group = tab.groupId !== -1 ? groupMap.get(tab.groupId) : null;
               if (group) {
                   tab.groupName = group.title || '';
                   tab.groupColor = group.color || null;
               }
               return tab;
           });
       }

       // Fuse.js fuzzy matching with title weighted 2x over URL
       const fuseResults = FuseSearchService.search(validTabs, query, {
           keys: [
               { name: 'title', weight: 2 },
               { name: 'url', weight: 1 }
           ]
       });

       const filteredTabs = fuseResults.map(result => {
           const tab = result.item;
           // Attach matchScore to tab for downstream scoring
           tab._matchScore = result.matchScore;
           const group = tab.groupId !== -1 ? groupMap.get(tab.groupId) : null;
           if (group) {
               tab.groupName = group.title || '';
               tab.groupColor = group.color || null;
           }
           return tab;
       });
       ```

       Remove the `.map(tab => { ... })` chain that was after the old `.filter()` since group mapping is now done inside the fuseResults.map.

    3. In the `getOpenTabs` method of base-data-provider.js (lines 164-185), update the SearchResult construction to pass matchScore into metadata:
       WAIT -- do NOT modify base-data-provider.js in this task. The matchScore integration into SearchResult will happen in Plan 03. For now, just store `_matchScore` on the tab object. The base-data-provider's getOpenTabs method can pick it up later.

       Actually, to keep things working end-to-end and satisfy MATCH-04, modify the getOpenTabs method in base-data-provider.js to propagate _matchScore:
       In the `results = tabsData.map(tab => new SearchResult({...}))` section, add `matchScore` to metadata:
       ```js
       metadata: {
           tabId: tab.id,
           windowId: tab.windowId,
           groupName: tab.groupName || null,
           groupColor: tab.groupColor || null,
           matchScore: tab._matchScore || null
       }
       ```

       IMPORTANT: Only add `matchScore` to the metadata object. Do NOT change the SearchResult class or any other scoring logic yet.
  </action>
  <verify>
    - `npm test` passes (existing tests may need minor adjustment if they test fuzzyMatch directly on provider, but those tests instantiate BaseDataProvider not BackgroundDataProvider, so they should still pass since fuzzyMatch still exists on BaseDataProvider)
    - `npm run build` succeeds without errors
  </verify>
  <done>
    getOpenTabsData uses FuseSearchService.search() with title weight:2 and url weight:1. Tab results include _matchScore from Fuse.js. The hand-rolled fuzzyMatch is no longer called for tab filtering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate pinned tab matching to Fuse.js</name>
  <files>shared/data-providers/background-data-provider.js</files>
  <action>
    Modify `getPinnedTabsData(query)` in background-data-provider.js:

    The current code (lines 182-189) does:
    ```js
    if (query) {
        const queryLower = query.toLowerCase();
        const titleMatch = this.fuzzyMatch(queryLower, bookmark.title.toLowerCase());
        const urlMatch = this.fuzzyMatch(queryLower, bookmark.url.toLowerCase());
        if (!titleMatch && !urlMatch) {
            continue;
        }
    }
    ```

    This is inside a `for (const bookmark of bookmarks)` loop that processes each space folder's bookmarks one at a time. The approach needs to change since Fuse.js works on arrays, not individual items.

    Refactor the matching section:
    1. After collecting ALL bookmarks from ALL space folders (with their spaceId, spaceName, spaceColor, tabId, isActive metadata attached), apply Fuse.js filtering in one batch.

    2. Restructure getPinnedTabsData:
       - Collect all pinned tab candidates first (the full loop without query filtering)
       - If query is provided, filter the collected candidates using FuseSearchService:
         ```js
         if (query) {
             const fuseResults = FuseSearchService.search(allPinnedCandidates, query, {
                 keys: [
                     { name: 'title', weight: 2 },
                     { name: 'url', weight: 1 }
                 ]
             });
             return fuseResults.map(result => {
                 const pinnedTab = result.item;
                 pinnedTab._matchScore = result.matchScore;
                 return pinnedTab;
             });
         }
         return allPinnedCandidates;
         ```

    3. Similarly propagate _matchScore through getPinnedTabSuggestions in base-data-provider.js. In the map inside getPinnedTabSuggestions (lines 218-234), add matchScore to metadata:
       ```js
       metadata: {
           bookmarkId: pinnedTab.id,
           spaceId: pinnedTab.spaceId,
           spaceName: pinnedTab.spaceName,
           spaceColor: pinnedTab.spaceColor,
           tabId: pinnedTab.tabId,
           isActive: pinnedTab.isActive,
           matchScore: pinnedTab._matchScore || null
       }
       ```

    IMPORTANT: Keep all existing Logger.log calls for debugging. Only replace the fuzzyMatch filtering logic.
  </action>
  <verify>
    - `npm test` passes
    - `npm run build` succeeds
    - No references to `this.fuzzyMatch` remain in background-data-provider.js (grep check)
  </verify>
  <done>
    getPinnedTabsData uses FuseSearchService.search() with title weight:2 and url weight:1. Pinned tab results include _matchScore from Fuse.js. No fuzzyMatch calls remain in background-data-provider.js.
  </done>
</task>

</tasks>

<verification>
After all 3 tasks:
1. `npm run build` completes without errors
2. `npm test` passes (existing test suite, fuzzyMatch tests still pass because fuzzyMatch still exists on BaseDataProvider)
3. `grep -r "this.fuzzyMatch" shared/data-providers/background-data-provider.js` returns no matches
4. `grep -r "FuseSearchService" shared/data-providers/background-data-provider.js` returns matches confirming Fuse.js is used
5. shared/fuse-search-service.js exists with FuseSearchService class
6. fuse.js is in package.json dependencies
</verification>

<success_criteria>
- Fuse.js v7.x installed as runtime dependency
- FuseSearchService wrapper exists with shared config (threshold 0.4, ignoreLocation true, includeScore true)
- getOpenTabsData uses Fuse.js for tab filtering (not fuzzyMatch)
- getPinnedTabsData uses Fuse.js for pinned tab filtering (not fuzzyMatch)
- Title matches weighted 2x over URL matches via Fuse.js keys config
- matchScore (0-1) attached to tab/pinned tab metadata
- Build succeeds, existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-fuse.js-matching-engine/09-01-SUMMARY.md`
</output>
