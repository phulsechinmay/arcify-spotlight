---
phase: 08-space-chip-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/data-providers/arcify-provider.js
  - shared/data-providers/base-data-provider.js
autonomous: true

must_haves:
  truths:
    - "enrichWithArcifyInfo injects spaceColor into result.metadata for Arcify-bookmarked results"
    - "arcifyProvider cache stores spaceColor per URL by cross-referencing chrome.storage.local spaces array"
    - "enrichWithArcifyInfo returns early when no Arcify folder exists (no wasted compute)"
    - "Default results (empty query) are enriched with Arcify metadata including spaceColor"
  artifacts:
    - path: "shared/data-providers/arcify-provider.js"
      provides: "spaceColor in cache entries via spaces array cross-reference"
      contains: "spaceColor"
    - path: "shared/data-providers/base-data-provider.js"
      provides: "spaceColor injection in enrichment, early return, default results enrichment"
      contains: "spaceColor"
  key_links:
    - from: "shared/data-providers/arcify-provider.js"
      to: "chrome.storage.local spaces array"
      via: "chrome.storage.local.get in rebuildCache"
      pattern: "chrome\\.storage\\.local\\.get.*spaces"
    - from: "shared/data-providers/base-data-provider.js"
      to: "shared/data-providers/arcify-provider.js"
      via: "getSpaceForUrl returns spaceColor"
      pattern: "spaceInfo\\.spaceColor"
---

<objective>
Extend the Arcify data pipeline to include spaceColor in cached URL-to-space mappings and inject it into search result metadata during enrichment. Add early return guards for graceful degradation when no Arcify folder exists, and extend default results to also receive Arcify enrichment.

Purpose: Phase 8 chip rendering requires spaceColor in result.metadata. Currently, arcifyProvider cache lacks color data (documented in Phase 7 deviation). This plan closes that data gap and adds the early-return optimization the user requested.

Output: arcifyProvider cache stores spaceColor per URL, enrichWithArcifyInfo injects spaceColor into metadata, early returns prevent wasted compute, and default results are also enriched.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-space-chip-ui/08-RESEARCH.md
@.planning/phases/08-space-chip-ui/08-CONTEXT.md
@.planning/phases/07-result-enrichment/07-01-SUMMARY.md
@shared/data-providers/arcify-provider.js
@shared/data-providers/base-data-provider.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spaceColor to arcifyProvider cache and add early return guards</name>
  <files>shared/data-providers/arcify-provider.js, shared/data-providers/base-data-provider.js</files>
  <action>
**In arcify-provider.js -- extend rebuildCache() to store spaceColor:**

1. Inside `rebuildCache()`, after getting the subtree and before the `for (const spaceFolder of subtree.children)` loop, fetch the spaces array from chrome.storage.local:
   ```
   const storage = await chrome.storage.local.get('spaces');
   const spaces = storage.spaces || [];
   ```
   This is the same pattern used by `getPinnedTabsData()` in background-data-provider.js.

2. Inside the loop over spaceFolder children, find the matching space by name to get its color:
   ```
   const space = spaces.find(s => s.name === spaceFolder.title);
   ```

3. Add `spaceColor` to the spaceInfo object passed to `processFolder()`:
   ```
   const spaceInfo = {
       spaceName: spaceFolder.title,
       spaceId: spaceFolder.id,
       spaceColor: space?.color || 'grey'
   };
   ```

4. Add a public method `hasData()` that checks if the provider has a cache with entries AND an arcifyFolderId. This is used by enrichWithArcifyInfo for early return:
   ```
   hasData() {
       return this.cache !== null && this.arcifyFolderId !== null;
   }
   ```

**In base-data-provider.js -- update enrichWithArcifyInfo():**

1. After the lazy import of arcifyProvider (lines 552-556), add an early return check:
   ```
   // Early return if no Arcify folder exists (skip compute)
   await this.arcifyProvider.ensureCacheBuilt();
   if (!this.arcifyProvider.hasData()) {
       return results;
   }
   ```
   This ensures we don't loop over results calling getSpaceForUrl when there's no Arcify data.

2. Inside the `if (spaceInfo)` block (around line 570), add spaceColor injection:
   ```
   result.metadata.spaceColor = spaceInfo.spaceColor || 'grey';
   ```
   This goes after the existing metadata assignments (spaceName, spaceId, bookmarkId, bookmarkTitle).

**In base-data-provider.js -- extend getDefaultResults():**

3. In `getDefaultResults()` method (around line 144), after `this.deduplicateResults(results)`, call `enrichWithArcifyInfo()` on the deduplicated results before returning:
   ```
   const deduplicatedResults = this.deduplicateResults(results);
   const enrichedResults = await this.enrichWithArcifyInfo(deduplicatedResults);
   return enrichedResults;
   ```
   This ensures chips appear on default results (empty query) too, not just when user types a query.

**Important:** Do NOT modify the processFolder method signature or behavior -- it already spreads spaceInfo into cache entries via `...spaceInfo`, so adding spaceColor to the spaceInfo object automatically includes it in cache entries.
  </action>
  <verify>
1. Run `npm test` to confirm existing tests pass (no regressions).
2. Grep arcify-provider.js for `spaceColor` -- should appear in rebuildCache spaceInfo object.
3. Grep base-data-provider.js for `spaceColor` -- should appear in enrichWithArcifyInfo metadata injection.
4. Grep base-data-provider.js for `hasData` -- should appear in early return guard.
5. Grep base-data-provider.js `getDefaultResults` for `enrichWithArcifyInfo` -- should appear in the method.
  </verify>
  <done>
1. arcifyProvider.rebuildCache() fetches spaces from chrome.storage.local and stores spaceColor per cache entry.
2. enrichWithArcifyInfo() injects spaceColor into result.metadata.
3. enrichWithArcifyInfo() returns early when no Arcify folder/data exists.
4. getDefaultResults() calls enrichWithArcifyInfo() before returning.
5. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes with no regressions.
2. arcify-provider.js cache entries include spaceColor field.
3. enrichWithArcifyInfo early-returns when arcifyProvider has no data.
4. Default results go through enrichment pipeline.
</verification>

<success_criteria>
- spaceColor flows from chrome.storage.local spaces array through arcifyProvider cache into result.metadata
- No Arcify folder means enrichWithArcifyInfo returns immediately (no wasted iteration)
- Default results (empty query) are enriched with Arcify metadata
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-space-chip-ui/08-01-SUMMARY.md`
</output>
