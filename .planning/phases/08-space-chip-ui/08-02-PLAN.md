---
phase: 08-space-chip-ui
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - shared/ui-utilities.js
  - shared/shared-component-logic.js
  - overlay.js
  - newtab.js
  - shared/spotlight-styles.css
autonomous: false

must_haves:
  truths:
    - "Arcify suggestion items show a colored space name chip inline with the URL text"
    - "Chip color matches the tab group color of the space"
    - "Keyboard arrow navigation skips chips (focus stays on suggestion items)"
    - "Chip text is readable against its background (WCAG 3:1 contrast)"
    - "Chips appear in both overlay mode and new-tab mode"
    - "No chips and no errors when Arcify folder is not found"
    - "Long space names truncate with ellipsis"
  artifacts:
    - path: "shared/ui-utilities.js"
      provides: "generateSpaceChipHTML() and getChipColors() utility methods"
      contains: "generateSpaceChipHTML"
    - path: "shared/shared-component-logic.js"
      provides: "Chip HTML integrated into generateResultsHTML()"
      contains: "generateSpaceChipHTML"
    - path: "overlay.js"
      provides: "Chip CSS in overlay inline styles"
      contains: "arcify-space-chip"
    - path: "newtab.js"
      provides: "Chip CSS in newtab inline styles"
      contains: "arcify-space-chip"
    - path: "shared/spotlight-styles.css"
      provides: "Chip CSS in shared stylesheet"
      contains: "arcify-space-chip"
  key_links:
    - from: "shared/shared-component-logic.js"
      to: "shared/ui-utilities.js"
      via: "SpotlightUtils.generateSpaceChipHTML(result)"
      pattern: "SpotlightUtils\\.generateSpaceChipHTML"
    - from: "shared/shared-component-logic.js"
      to: "result.metadata.spaceName"
      via: "Conditional chip rendering based on spaceName presence"
      pattern: "spaceName"
    - from: "overlay.js"
      to: "CSS class arcify-space-chip"
      via: "Inline style definition"
      pattern: "arcify-space-chip"
---

<objective>
Add space chip rendering to the Spotlight UI -- a colored pill-shaped badge showing the space name inline with the URL text for Arcify suggestion items. Implement the chip HTML generator, integrate it into the rendering pipeline, and add CSS to all three style locations (overlay, newtab, shared stylesheet).

Purpose: This is the visible user-facing feature of Phase 8. Users see which Arcify space a suggestion belongs to via a compact, accessible color-coded chip next to the URL.

Output: Colored space name chips visible on Arcify suggestion items in both overlay and new-tab Spotlight modes.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-space-chip-ui/08-RESEARCH.md
@.planning/phases/08-space-chip-ui/08-CONTEXT.md
@.planning/phases/08-space-chip-ui/08-01-SUMMARY.md
@shared/ui-utilities.js
@shared/shared-component-logic.js
@overlay.js
@newtab.js
@shared/spotlight-styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chip color utility and HTML generator to ui-utilities.js</name>
  <files>shared/ui-utilities.js</files>
  <action>
Add two new static methods to the `SpotlightUtils` class in ui-utilities.js:

**1. getChipColors(colorName) -- returns {bg, text} for chip styling:**

Maps Chrome tab group color names to chip background and text colors. Strategy: use rgba(color, 0.15) as background tint, full color as text. All combinations pass WCAG 3:1 contrast against the dark (#2D2D2D) result item background.

```javascript
static getChipColors(colorName) {
    const chipColorMap = {
        grey:   { bg: 'rgba(204, 204, 204, 0.15)', text: 'rgb(204, 204, 204)' },
        blue:   { bg: 'rgba(139, 179, 243, 0.15)', text: 'rgb(139, 179, 243)' },
        red:    { bg: 'rgba(255, 158, 151, 0.15)', text: 'rgb(255, 158, 151)' },
        yellow: { bg: 'rgba(255, 226, 159, 0.15)', text: 'rgb(255, 226, 159)' },
        green:  { bg: 'rgba(139, 218, 153, 0.15)', text: 'rgb(139, 218, 153)' },
        pink:   { bg: 'rgba(251, 170, 215, 0.15)', text: 'rgb(251, 170, 215)' },
        purple: { bg: 'rgba(214, 166, 255, 0.15)', text: 'rgb(214, 166, 255)' },
        cyan:   { bg: 'rgba(165, 226, 234, 0.15)', text: 'rgb(165, 226, 234)' },
        orange: { bg: 'rgba(255, 176, 103, 0.15)', text: 'rgb(255, 176, 103)' }
    };
    return chipColorMap[colorName] || chipColorMap.grey;
}
```

The RGB values come from the existing `defaultColorMap` already in ui-utilities.js (line ~236). This maintains visual consistency.

**2. generateSpaceChipHTML(result) -- returns chip HTML string or empty string:**

```javascript
static generateSpaceChipHTML(result) {
    const spaceName = result.metadata?.spaceName;
    if (!spaceName) return '';

    const spaceColor = result.metadata?.spaceColor || 'grey';
    const chipColors = SpotlightUtils.getChipColors(spaceColor);
    const truncatedName = spaceName.length > 18 ? spaceName.substring(0, 18) + '\u2026' : spaceName;

    return `<span class="arcify-space-chip" style="background:${chipColors.bg};color:${chipColors.text}" title="${SpotlightUtils.escapeHtml(spaceName)}">${SpotlightUtils.escapeHtml(truncatedName)}</span>`;
}
```

Key details:
- Uses `<span>` (not button/link) to keep it non-interactive (CHIP-03).
- Inline style for color because each chip has a different color based on its space.
- CSS class `arcify-space-chip` handles layout/shape (defined in CSS).
- `title` attribute shows full name on hover for truncated names.
- Truncation at 18 chars with unicode ellipsis character.
- Returns empty string when no spaceName -- this is the graceful degradation path (CHIP-05).
  </action>
  <verify>
1. Grep ui-utilities.js for `getChipColors` -- method exists with all 9 Chrome tab group colors.
2. Grep ui-utilities.js for `generateSpaceChipHTML` -- method exists, returns empty string when no spaceName.
3. `npm test` passes.
  </verify>
  <done>
- getChipColors() maps all 9 Chrome tab group colors to accessible bg/text pairs.
- generateSpaceChipHTML() generates chip HTML for results with spaceName, returns '' otherwise.
- Both methods are static on SpotlightUtils class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate chip into rendering pipeline and add CSS to all 3 style locations</name>
  <files>shared/shared-component-logic.js, overlay.js, newtab.js, shared/spotlight-styles.css</files>
  <action>
**1. Modify generateResultsHTML() in shared-component-logic.js:**

Update the result template in `generateResultsHTML()` to include chip HTML and wrap URL content in flex-compatible structure.

Replace the current URL line:
```
<div class="arcify-spotlight-result-url">${SpotlightUtils.escapeHtml(formatted.subtitle)}${SpotlightUtils.formatDebugInfo(result)}</div>
```

With conditional chip rendering:
```javascript
const chipHtml = SpotlightUtils.generateSpaceChipHTML(result);

// If chip exists, wrap URL text in span for flex layout; otherwise keep as text node
const urlContent = formatted.subtitle
    ? (chipHtml
        ? `<span class="arcify-spotlight-result-url-text">${SpotlightUtils.escapeHtml(formatted.subtitle)}</span>${SpotlightUtils.formatDebugInfo(result)}${chipHtml}`
        : `${SpotlightUtils.escapeHtml(formatted.subtitle)}${SpotlightUtils.formatDebugInfo(result)}`)
    : '';
```

Then use `urlContent` in the template where the URL div is:
```
<div class="arcify-spotlight-result-url">${urlContent}</div>
```

This approach:
- Only adds flex wrapper span when chip is present (avoids unnecessary DOM for non-Arcify results).
- URL text gets its own span with truncation (`.arcify-spotlight-result-url-text`).
- Chip is a sibling span that won't shrink (`flex-shrink: 0`).
- Debug info stays between URL and chip.

**2. Add chip CSS to all THREE style locations:**

Add the following CSS block to: (a) overlay.js spotlightCSS template literal, (b) newtab.js spotlightCSS template literal, (c) shared/spotlight-styles.css.

The CSS goes right after the existing `.arcify-spotlight-result-url:empty` rule in each location:

```css
/* Space chip - inline with URL */
.arcify-spotlight-result-url-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0;
}

.arcify-space-chip {
    display: inline-flex;
    align-items: center;
    padding: 1px 8px;
    border-radius: 9999px;
    font-size: 10px;
    font-weight: 500;
    line-height: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 140px;
    flex-shrink: 0;
}
```

**3. Modify the existing `.arcify-spotlight-result-url` rule in all THREE locations:**

Change the existing rule from block-level text truncation to flex layout. The current rule is:
```css
.arcify-spotlight-result-url {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
```

Update it to:
```css
.arcify-spotlight-result-url {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    overflow: hidden;
}
```

Key changes: `display: flex`, `align-items: center`, `gap: 6px` added. `white-space: nowrap` and `text-overflow: ellipsis` removed from the parent (moved to `.arcify-spotlight-result-url-text` child). This makes the URL line a flex container where URL text truncates while chip stays visible.

**Important:** Keep the `.arcify-spotlight-result-url:empty { display: none; }` rule unchanged -- it still handles the case where no URL content exists.

For non-chip results (no `.arcify-spotlight-result-url-text` span), the URL text is a direct text node in a flex container. Flex treats text nodes as anonymous flex items, so `white-space: nowrap` and `text-overflow: ellipsis` won't apply to bare text nodes. To fix this, add:
```css
.arcify-spotlight-result-url {
    /* ...existing flex properties... */
    white-space: nowrap;
    text-overflow: ellipsis;
}
```
Keep `white-space: nowrap` and `text-overflow: ellipsis` ON the parent too, so non-chip URLs still truncate properly. The flex display with these properties will still work for bare text content.
  </action>
  <verify>
1. Grep shared-component-logic.js for `generateSpaceChipHTML` -- called in generateResultsHTML.
2. Grep overlay.js for `arcify-space-chip` -- CSS class exists in inline styles.
3. Grep newtab.js for `arcify-space-chip` -- CSS class exists in inline styles.
4. Grep spotlight-styles.css for `arcify-space-chip` -- CSS class exists.
5. Grep overlay.js, newtab.js, spotlight-styles.css for `arcify-spotlight-result-url-text` -- flex child class exists in all 3.
6. `npm test` passes.
7. Load the extension in Chrome. Open Spotlight. If you have Arcify bookmarks with spaces, verify chips appear inline with URLs. If no Arcify bookmarks, verify no errors and no chips.
  </verify>
  <done>
- generateResultsHTML renders space chips inline with URL for Arcify results.
- Chip CSS (pill shape, flex layout, truncation) present in overlay.js, newtab.js, and spotlight-styles.css.
- URL line uses flex layout with chip as non-shrinking flex child.
- Non-Arcify results render unchanged (no chip, no extra wrapper span).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Space chip UI rendering for Arcify suggestion items. Colored pill-shaped badges showing space names appear inline with URLs in Spotlight search results. Covers both overlay mode and new-tab mode.
  </what-built>
  <how-to-verify>
1. Load the updated extension in Chrome (chrome://extensions -> reload).
2. Open Spotlight in overlay mode (hotkey on any tab).
3. Type a query that matches a URL bookmarked in your Arcify folder structure.
4. Verify: A colored pill chip appears to the right of the URL text showing the space name.
5. Verify: Chip color matches the tab group color of that space.
6. Verify: Arrow keys navigate between suggestion items -- chips are NOT focusable/selectable.
7. Verify: Long space names truncate with ellipsis. Hover shows full name in tooltip.
8. Open Spotlight in new-tab mode (new tab page).
9. Verify: Chips also appear in new-tab mode with same styling.
10. Verify: Default results (no query typed) also show chips for Arcify tabs.
11. If you have no Arcify bookmarks: Verify Spotlight works normally with no errors and no chip elements visible.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues</resume-signal>
</task>

</tasks>

<verification>
1. All 5 CHIP requirements addressed:
   - CHIP-01: Chip appears below/inline with Arcify suggestions (generateSpaceChipHTML + generateResultsHTML)
   - CHIP-02: Chip color matches tab group color (getChipColors using defaultColorMap RGB values)
   - CHIP-03: Chip is static/non-interactive (span element, no tabindex, no button/link)
   - CHIP-04: WCAG 3:1 contrast (full color text on 15% opacity tint background, all verified)
   - CHIP-05: Graceful degradation (generateSpaceChipHTML returns '' when no spaceName, early return in enrichment)
2. `npm test` passes with no regressions.
3. Chips visible in both overlay and new-tab Spotlight modes.
4. Keyboard navigation unaffected by chips.
</verification>

<success_criteria>
- Colored space name chips appear inline with URL for Arcify suggestion items
- Chip background uses 15% opacity tint of space color; text uses full space color
- Arrow key navigation skips chips entirely (focus on result items only)
- No chips, no errors when Arcify folder is absent
- Both overlay and new-tab modes show consistent chip appearance
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-space-chip-ui/08-02-SUMMARY.md`
</output>
