---
phase: 03-unit-tests-chrome-api-mocks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/mocks/chrome.js
  - test/unit/search-engine-cache.test.js
autonomous: true

must_haves:
  truths:
    - "Second identical query within 30s returns cached results without API call"
    - "Query after 30s TTL expires triggers fresh API call"
    - "Different queries are cached independently"
    - "Different modes for same query are cached independently"
  artifacts:
    - path: "test/mocks/chrome.js"
      provides: "Extended Chrome mock with search.query and topSites.get"
      contains: "search:"
    - path: "test/unit/search-engine-cache.test.js"
      provides: "Cache behavior tests"
      min_lines: 80
  key_links:
    - from: "test/unit/search-engine-cache.test.js"
      to: "shared/search-engine.js"
      via: "imports SearchEngine"
      pattern: "import.*SearchEngine.*from"
    - from: "test/unit/search-engine-cache.test.js"
      to: "test/mocks/chrome.js"
      via: "uses chromeMock via setup.js"
      pattern: "vi\\.useFakeTimers"
---

<objective>
Extend Chrome API mocks and test SearchEngine caching behavior.

Purpose: Verify cache returns results within TTL without re-querying data provider (MOCK-01)
Output: Extended chrome mock + comprehensive cache tests
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-unit-tests-chrome-api-mocks/03-RESEARCH.md

@shared/search-engine.js
@shared/search-types.js
@test/mocks/chrome.js
@test/setup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Chrome mock with search and topSites APIs</name>
  <files>test/mocks/chrome.js</files>
  <action>
Add two new API mocks to chromeMock object:

1. Add chrome.search mock:
```javascript
search: {
  query: vi.fn().mockResolvedValue(undefined)
}
```

2. Add chrome.topSites mock:
```javascript
topSites: {
  get: vi.fn().mockResolvedValue([])
}
```

3. Add resets to resetChromeMocks() function:
```javascript
chromeMock.search.query.mockClear().mockResolvedValue(undefined);
chromeMock.topSites.get.mockClear().mockResolvedValue([]);
```

Place new mocks after the existing `windows` block to maintain alphabetical-ish ordering.
  </action>
  <verify>
Run existing tests to ensure mock extension doesn't break anything:
```bash
npm test
```
All 151 existing tests should still pass.
  </verify>
  <done>chrome.search.query and chrome.topSites.get are mockable in tests, existing tests unaffected</done>
</task>

<task type="auto">
  <name>Task 2: Create SearchEngine cache tests</name>
  <files>test/unit/search-engine-cache.test.js</files>
  <action>
Create test file for SearchEngine caching behavior (MOCK-01).

CRITICAL: Use vi.advanceTimersByTimeAsync() (not sync version) to prevent promise/timer deadlocks.

Test structure:
```javascript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { SearchEngine } from '../../shared/search-engine.js';
import { SpotlightTabMode } from '../../shared/search-types.js';

describe('SearchEngine.getSpotlightSuggestionsUsingCache', () => {
    let engine;
    let mockProvider;

    beforeEach(() => {
        vi.useFakeTimers();
        mockProvider = {
            isBackgroundProvider: true,
            getSpotlightSuggestions: vi.fn().mockResolvedValue([
                { type: 'open-tab', title: 'Test', url: 'https://test.com' }
            ])
        };
        engine = new SearchEngine(mockProvider);
    });

    afterEach(() => {
        vi.useRealTimers();
    });

    // Tests go here
});
```

Required test cases (use table-driven it.each where appropriate):

1. **Cache hit within TTL:**
   - First call triggers provider
   - Advance 15s (within 30s TTL)
   - Second identical call returns cached (provider called only once)

2. **Cache miss after TTL expires:**
   - First call triggers provider
   - Advance 30001ms (past 30s TTL)
   - Second call triggers provider again (called twice)

3. **Different queries cached independently:**
   - Call with query "foo"
   - Call with query "bar"
   - Both trigger provider (called twice)

4. **Different modes cached independently:**
   - Call with "test" in CURRENT_TAB mode
   - Call with "test" in NEW_TAB mode
   - Both trigger provider (called twice) - cache key includes mode

5. **Cache key uses trimmed query:**
   - Call with "  test  " (whitespace)
   - Advance past debounce
   - Call with "test" (no whitespace)
   - Second should hit cache (provider called once)

Remember debounce delay is 150ms - must advance past that first before cache is populated.

Pattern for each test:
```javascript
it('description', async () => {
    // First call
    const promise1 = engine.getSpotlightSuggestionsUsingCache('query', 'current-tab');
    await vi.advanceTimersByTimeAsync(151); // Past debounce
    await promise1;

    // Time manipulation if needed
    await vi.advanceTimersByTimeAsync(X);

    // Second call
    const promise2 = engine.getSpotlightSuggestionsUsingCache('query', 'current-tab');
    await vi.advanceTimersByTimeAsync(151); // If not cached, needs debounce
    await promise2;

    expect(mockProvider.getSpotlightSuggestions).toHaveBeenCalledTimes(N);
});
```
  </action>
  <verify>
Run cache tests:
```bash
npm test -- test/unit/search-engine-cache.test.js
```
All cache tests should pass.
  </verify>
  <done>5+ cache behavior tests passing, covering TTL hit/miss, independent caching by query and mode</done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test
```

Expected: 156+ tests passing (151 existing + 5+ new cache tests)
</verification>

<success_criteria>
1. chrome.search.query and chrome.topSites.get mocks available in test environment
2. Cache tests verify second identical query within TTL returns cached results without API call
3. Cache tests verify query after TTL expires triggers fresh API call
4. All existing tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-unit-tests-chrome-api-mocks/03-01-SUMMARY.md`
</output>
