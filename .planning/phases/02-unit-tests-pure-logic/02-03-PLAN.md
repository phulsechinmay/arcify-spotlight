---
phase: 02-unit-tests-pure-logic
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/selection-manager.test.js
autonomous: true

must_haves:
  truths:
    - "Selection moves down correctly within bounds"
    - "Selection clamps at maximum index (cannot go past last item)"
    - "Selection clamps at minimum index (cannot go below 0)"
    - "Home key moves to first item"
    - "End key moves to last item"
    - "Selection change callback fires only when selection actually changes"
    - "updateResults resets selection to 0 without firing callback"
  artifacts:
    - path: "test/unit/selection-manager.test.js"
      provides: "SelectionManager navigation tests"
      contains: "describe.*SelectionManager"
  key_links:
    - from: "test/unit/selection-manager.test.js"
      to: "shared/selection-manager.js"
      via: "import SelectionManager"
      pattern: "import.*SelectionManager.*from"
---

<objective>
Create unit tests for SelectionManager keyboard navigation.

Purpose: Validates selection navigation (UNIT-06) including bounds checking for up/down/home/end movements. SelectionManager is used for keyboard navigation in the spotlight overlay.

Output: Test file with comprehensive navigation tests using mocked container.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-unit-tests-pure-logic/02-RESEARCH.md

# Source file under test
@shared/selection-manager.js

# Test infrastructure from Phase 1
@vitest.config.js
@test/setup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: SelectionManager tests (navigation, bounds, callbacks)</name>
  <files>test/unit/selection-manager.test.js</files>
  <action>
Create comprehensive test file for SelectionManager.

Imports:
```javascript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { SelectionManager } from '../../shared/selection-manager.js';
```

Create mock container and items in beforeEach:
```javascript
let manager;
let mockContainer;
let selectionCallback;
let mockItems;

beforeEach(() => {
  // Create mock DOM items with required methods
  mockItems = [
    { classList: { toggle: vi.fn() }, scrollIntoView: vi.fn() },
    { classList: { toggle: vi.fn() }, scrollIntoView: vi.fn() },
    { classList: { toggle: vi.fn() }, scrollIntoView: vi.fn() },
  ];

  mockContainer = {
    querySelectorAll: vi.fn().mockReturnValue(mockItems),
    contains: vi.fn().mockReturnValue(true)
  };

  selectionCallback = vi.fn();
  manager = new SelectionManager(mockContainer, selectionCallback);
  manager.updateResults([{ id: 1 }, { id: 2 }, { id: 3 }]);
});
```

Organize tests in describe blocks:

describe('moveSelection', () => {
  Test 'down' movement:
  - Starting at 0, moveSelection('down') sets selectedIndex to 1
  - Callback is called with (result at index 1, 1)

  Test 'up' movement:
  - Starting at 2, moveSelection('up') sets selectedIndex to 1
  - Starting at 0, moveSelection('up') keeps selectedIndex at 0 (clamped)
  - Callback is NOT called when selection doesn't change

  Test bounds clamping:
  - Starting at 2 (last), moveSelection('down') keeps selectedIndex at 2
  - Callback is NOT called when clamped at bounds
});

describe('moveToFirst', () => {
  - Starting at 2, moveToFirst() sets selectedIndex to 0
  - Starting at 0, moveToFirst() keeps selectedIndex at 0
  - Callback is called only when selection actually changes
});

describe('moveToLast', () => {
  - Starting at 0, moveToLast() sets selectedIndex to 2 (results.length - 1)
  - Starting at 2, moveToLast() keeps selectedIndex at 2
  - With empty results, moveToLast() keeps selectedIndex at 0
  - Callback is called only when selection actually changes
});

describe('getSelectedResult', () => {
  - Returns the result at selectedIndex
  - Returns null if index is out of bounds (e.g., empty results)
});

describe('updateResults', () => {
  - Resets selectedIndex to 0
  - Does NOT trigger onSelectionChange callback
  - Stores new results array
});

describe('updateVisualSelection', () => {
  - Calls toggle('selected', true) on item at selectedIndex
  - Calls toggle('selected', false) on other items
  - Calls scrollIntoView on selected item
});

describe('handleKeyDown', () => {
  Test with mock events:
  ```javascript
  const createMockEvent = (key) => ({
    key,
    preventDefault: vi.fn(),
    stopPropagation: vi.fn()
  });
  ```

  - ArrowDown calls moveSelection('down'), returns true
  - ArrowUp calls moveSelection('up'), returns true
  - Home calls moveToFirst(), returns true
  - End calls moveToLast(), returns true
  - Other keys (e.g., 'a') return false, don't call navigation
  - All handled keys call preventDefault and stopPropagation
});

Edge cases to test:
- Empty results array: navigation should not crash
- Single result: up/down should stay at 0
  </action>
  <verify>
Run `npm test -- test/unit/selection-manager.test.js` - all tests pass.
  </verify>
  <done>
SelectionManager correctly navigates up/down with bounds clamping. Home/End move to first/last. Callbacks fire only on actual changes. updateResults resets without callback.
  </done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test
```

Expected: All SelectionManager tests pass.

Verify specific requirements:
- UNIT-06: Tests verify up/down/home/end navigation stays within bounds
- Bounds checking prevents selectedIndex < 0 or >= results.length
</verification>

<success_criteria>
1. test/unit/selection-manager.test.js exists with 20+ test cases
2. All tests pass when running `npm test`
3. Tests cover: moveSelection (up/down), moveToFirst, moveToLast, getSelectedResult, updateResults, handleKeyDown
4. Tests verify callback behavior (fires on change, not on no-change)
5. Tests verify bounds clamping at both ends
</success_criteria>

<output>
After completion, create `.planning/phases/02-unit-tests-pure-logic/02-03-SUMMARY.md`
</output>
