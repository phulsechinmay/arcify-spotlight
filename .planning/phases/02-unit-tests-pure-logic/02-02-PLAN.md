---
phase: 02-unit-tests-pure-logic
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/fuzzy-matching.test.js
  - test/unit/scoring.test.js
autonomous: true

must_haves:
  truths:
    - "Fuzzy matching returns true when query characters appear in order in text"
    - "Fuzzy matching returns false when characters are out of order"
    - "Fuzzy matching is case insensitive"
    - "findMatchingDomains returns popular sites matching partial input"
    - "Relevance scoring applies correct bonuses for title/URL matches"
    - "Autocomplete scores decrease by position index"
  artifacts:
    - path: "test/unit/fuzzy-matching.test.js"
      provides: "fuzzyMatch and findMatchingDomains tests"
      contains: "describe.*fuzzyMatch"
    - path: "test/unit/scoring.test.js"
      provides: "scoring functions and relevance bonus tests"
      contains: "describe.*getAutocompleteScore"
  key_links:
    - from: "test/unit/fuzzy-matching.test.js"
      to: "shared/data-providers/base-data-provider.js"
      via: "import BaseDataProvider"
      pattern: "import.*BaseDataProvider.*from"
    - from: "test/unit/fuzzy-matching.test.js"
      to: "shared/popular-sites.js"
      via: "import findMatchingDomains"
      pattern: "import.*findMatchingDomains.*from"
    - from: "test/unit/scoring.test.js"
      to: "shared/scoring-constants.js"
      via: "import scoring functions"
      pattern: "import.*getAutocompleteScore.*from"
---

<objective>
Create unit tests for fuzzy matching and relevance scoring systems.

Purpose: Validates fuzzy matching algorithm (UNIT-03) and scoring system (UNIT-04). These functions control search result ordering and domain autocomplete - critical for user experience.

Output: Two test files covering fuzzy matching edge cases and scoring bonus calculations.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-unit-tests-pure-logic/02-RESEARCH.md

# Source files under test
@shared/data-providers/base-data-provider.js
@shared/popular-sites.js
@shared/scoring-constants.js

# Test infrastructure from Phase 1
@vitest.config.js
@test/setup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fuzzy matching tests (fuzzyMatch, findMatchingDomains)</name>
  <files>test/unit/fuzzy-matching.test.js</files>
  <action>
Create test file for fuzzy matching functions.

Imports:
```javascript
import { describe, it, expect, beforeEach } from 'vitest';
import { BaseDataProvider } from '../../shared/data-providers/base-data-provider.js';
import { findMatchingDomains } from '../../shared/popular-sites.js';
```

For BaseDataProvider.fuzzyMatch tests (UNIT-03):

Create testable instance:
```javascript
let provider;
beforeEach(() => {
  provider = Object.create(BaseDataProvider.prototype);
});
```

Use it.each() for fuzzyMatch test cases:

Matches (should return true):
- ['ghub', 'GitHub'] - characters in order
- ['yt', 'YouTube'] - abbreviation match
- ['gml', 'Gmail'] - consonant match
- ['fb', 'Facebook'] - start letters
- ['github', 'GitHub'] - exact match (contains)
- ['GHUB', 'github'] - case insensitive

Non-matches (should return false):
- ['hbug', 'GitHub'] - out of order (h after g in query, but g before h in text)
- ['xyz', 'GitHub'] - characters not present
- ['', 'GitHub'] - empty query
- ['git', ''] - empty text

For findMatchingDomains tests (UNIT-03):

Test matchType: 'start':
- Input: 'git' should include { domain: 'github.com', matchType: 'start' }
- Input: 'squaresp' should include { domain: 'squarespace.com', matchType: 'start' }

Test matchType: 'contains':
- Input: 'tube' should include { domain: 'youtube.com', matchType: 'contains' }

Test matchType: 'name':
- Input: 'Amazon' should include { domain: 'amazon.com', matchType: 'name' }

Test empty input:
- Input: '' should return empty array

Test maxResults parameter:
- findMatchingDomains('g', 3) should return at most 3 results

Verify return structure includes: domain, displayName, score, matchType
  </action>
  <verify>
Run `npm test -- test/unit/fuzzy-matching.test.js` - all tests pass.
  </verify>
  <done>
fuzzyMatch correctly identifies character-in-sequence patterns and rejects out-of-order matches. findMatchingDomains returns popular sites with correct matchType classifications.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scoring tests (getAutocompleteScore, getFuzzyMatchScore, calculateRelevanceScore)</name>
  <files>test/unit/scoring.test.js</files>
  <action>
Create test file for scoring functions.

Imports:
```javascript
import { describe, it, expect, beforeEach } from 'vitest';
import {
  BASE_SCORES,
  SCORE_BONUSES,
  getAutocompleteScore,
  getFuzzyMatchScore
} from '../../shared/scoring-constants.js';
import { BaseDataProvider } from '../../shared/data-providers/base-data-provider.js';
```

For getAutocompleteScore tests (UNIT-04):
- Index 0 returns 30 (BASE_SCORES.AUTOCOMPLETE_SUGGESTION - 0)
- Index 1 returns 29
- Index 4 returns 26
- Scores decrease by 1 per position

For getFuzzyMatchScore tests (UNIT-04):

Use it.each():
- matchType: 'start' returns score >= 62 (minimum is FUZZY_MATCH_NAME)
- matchType: 'contains' returns 63 (FUZZY_MATCH_CONTAINS)
- matchType: 'name' returns 62 (FUZZY_MATCH_NAME)
- matchType: 'unknown' returns 60 (FUZZY_MATCH_DEFAULT)

Test 'start' with length penalty:
- getFuzzyMatchScore('start', 10, 3) should be less than getFuzzyMatchScore('start', 6, 3)
- Longer domains get lower scores for 'start' matches

For calculateRelevanceScore tests (UNIT-04):

Create testable instance:
```javascript
let provider;
beforeEach(() => {
  provider = Object.create(BaseDataProvider.prototype);
});
```

Test base scores by result type:
- type: 'open-tab' returns BASE_SCORES.OPEN_TAB (90)
- type: 'bookmark' returns BASE_SCORES.BOOKMARK (80)
- type: 'history' returns BASE_SCORES.HISTORY (70)

Test bonuses (create result objects with title and url properties):
- Exact title match: result with title='github', query='github' -> base + 20
- Title starts with: result with title='github repo', query='github' -> base + 15
- Title contains: result with title='my github page', query='github' -> base + 10
- URL contains: result with url='https://github.com', query='github' -> base + 5

Test combined bonuses:
- Title exact + URL contains: should get both bonuses (20 + 5 = 25 bonus)

Test fuzzy match passthrough:
- Result with metadata.fuzzyMatch=true should return result.score directly (no recalculation)
  </action>
  <verify>
Run `npm test -- test/unit/scoring.test.js` - all tests pass.
  </verify>
  <done>
getAutocompleteScore decreases by position. getFuzzyMatchScore applies correct scores with length penalty. calculateRelevanceScore applies bonuses correctly for title/URL matches.
  </done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test
```

Expected: All fuzzy matching and scoring tests pass.

Verify specific requirements:
- UNIT-03: fuzzyMatch tests verify 'ghub' matches 'GitHub' and rejects 'hbug' (out of order)
- UNIT-04: scoring tests verify bonuses are applied correctly (exact +20, starts +15, contains +10, URL +5)
</verification>

<success_criteria>
1. test/unit/fuzzy-matching.test.js exists with 12+ test cases
2. test/unit/scoring.test.js exists with 15+ test cases
3. All tests pass when running `npm test`
4. fuzzyMatch tests include both positive and negative (out-of-order) cases
5. Scoring tests verify all four bonus types
</success_criteria>

<output>
After completion, create `.planning/phases/02-unit-tests-pure-logic/02-02-SUMMARY.md`
</output>
