---
phase: 02-unit-tests-pure-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/url-utilities.test.js
  - test/unit/deduplication.test.js
autonomous: true

must_haves:
  truths:
    - "URL detection correctly identifies valid URLs (domains, localhost, IPs)"
    - "URL detection correctly rejects search queries"
    - "URL normalization adds https to protocol-less URLs"
    - "Deduplication normalization handles fragments, trailing slashes, www, protocol"
    - "Deduplication priority correctly ranks open tabs above history"
  artifacts:
    - path: "test/unit/url-utilities.test.js"
      provides: "isURL and normalizeURL tests"
      contains: "describe.*isURL"
    - path: "test/unit/deduplication.test.js"
      provides: "normalizeUrlForDeduplication and getResultPriority tests"
      contains: "describe.*normalizeUrlForDeduplication"
  key_links:
    - from: "test/unit/url-utilities.test.js"
      to: "shared/ui-utilities.js"
      via: "import SpotlightUtils"
      pattern: "import.*SpotlightUtils.*from"
    - from: "test/unit/deduplication.test.js"
      to: "shared/data-providers/base-data-provider.js"
      via: "import BaseDataProvider"
      pattern: "import.*BaseDataProvider.*from"
---

<objective>
Create unit tests for URL utilities and deduplication logic.

Purpose: Validates URL detection/normalization (UNIT-01, UNIT-05) and deduplication behavior (UNIT-02) with comprehensive edge case coverage. These are foundational pure functions used throughout the spotlight system.

Output: Two test files with table-driven tests covering all edge cases from requirements.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-unit-tests-pure-logic/02-RESEARCH.md

# Source files under test
@shared/ui-utilities.js
@shared/data-providers/base-data-provider.js
@shared/scoring-constants.js

# Test infrastructure from Phase 1
@vitest.config.js
@test/setup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: URL utilities tests (isURL, normalizeURL)</name>
  <files>test/unit/url-utilities.test.js</files>
  <action>
Create test file for SpotlightUtils.isURL() and SpotlightUtils.normalizeURL().

Import:
```javascript
import { describe, it, expect } from 'vitest';
import { SpotlightUtils } from '../../shared/ui-utilities.js';
```

For isURL tests (UNIT-05), use it.each() with these test cases:

Valid URLs (should return true):
- 'https://example.com' - complete URL with https
- 'http://example.com' - complete URL with http
- 'example.com' - domain without protocol
- 'sub.example.com' - subdomain
- 'example.co.uk' - multi-part TLD
- 'localhost' - localhost
- 'localhost:3000' - localhost with port
- '192.168.1.1' - valid IP address
- '192.168.1.1:8080' - IP with port
- 'github.io' - short domain with valid TLD

Invalid URLs / Search queries (should return false):
- 'hello world' - space-separated words
- 'github' - single word without TLD
- 'how to code' - multi-word query
- 'what is github.com' - query containing domain (has spaces)
- '999.999.999.999' - invalid IP (octets > 255)
- 'file.txt' - file extension, not domain (no TLD in allowed list)

For normalizeURL tests (UNIT-01):
- 'example.com' -> 'https://example.com' (no protocol)
- 'https://example.com' -> 'https://example.com' (already has https)
- 'http://example.com' -> 'http://example.com' (keep http)
- 'chrome://settings' -> 'chrome://settings' (chrome protocol)
- 'file:///path' -> 'file:///path' (file protocol)

Structure tests in describe blocks: 'SpotlightUtils.isURL' with nested 'valid URLs' and 'invalid URLs (search queries)', and 'SpotlightUtils.normalizeURL'.
  </action>
  <verify>
Run `npm test -- test/unit/url-utilities.test.js` - all tests pass.
  </verify>
  <done>
isURL correctly identifies valid URLs and rejects search queries. normalizeURL adds https protocol only when needed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deduplication tests (normalizeUrlForDeduplication, getResultPriority)</name>
  <files>test/unit/deduplication.test.js</files>
  <action>
Create test file for BaseDataProvider deduplication methods.

Import:
```javascript
import { describe, it, expect, beforeEach } from 'vitest';
import { BaseDataProvider } from '../../shared/data-providers/base-data-provider.js';
```

Note: BaseDataProvider methods are instance methods, not static. Create a testable instance:
```javascript
let provider;
beforeEach(() => {
  provider = Object.create(BaseDataProvider.prototype);
});
```

For normalizeUrlForDeduplication tests (UNIT-01), use it.each():
- 'https://example.com#section' -> 'example.com' (fragment removed)
- 'https://example.com/' -> 'example.com' (trailing slash removed)
- 'https://example.com///' -> 'example.com' (multiple trailing slashes)
- 'http://example.com' -> 'example.com' (protocol removed)
- 'https://www.example.com' -> 'example.com' (www prefix removed)
- 'HTTPS://EXAMPLE.COM' -> 'example.com' (lowercased)
- 'https://example.com?q=test' -> 'example.com?q=test' (query params preserved)
- '' -> '' (empty string)
- null -> '' (null input - test with separate it() block)

For getResultPriority tests (UNIT-02), verify priority hierarchy:
- 'open-tab' returns 90 (BASE_SCORES.OPEN_TAB)
- 'pinned-tab' returns 85 (BASE_SCORES.PINNED_TAB)
- 'bookmark' returns 80 (BASE_SCORES.BOOKMARK)
- 'history' returns 70 (BASE_SCORES.HISTORY)
- 'top-site' returns 60 (BASE_SCORES.TOP_SITE)
- 'autocomplete-suggestion' returns 30 (BASE_SCORES.AUTOCOMPLETE_SUGGESTION)

Add a describe block 'deduplication behavior' with tests:
- 'open-tab wins over history for same URL' - create two results with same URL, different types, verify getResultPriority returns higher for open-tab
- 'bookmark wins over history for same URL' - same pattern

Import BASE_SCORES from scoring-constants.js for expected values.
  </action>
  <verify>
Run `npm test -- test/unit/deduplication.test.js` - all tests pass.
  </verify>
  <done>
URL normalization strips fragments/slashes/www/protocol while preserving query params. Priority hierarchy correctly ranks open tabs > bookmarks > history.
  </done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test
```

Expected: All URL utilities and deduplication tests pass. Coverage increases from 0%.

Verify specific requirements:
- UNIT-01: normalizeURL and normalizeUrlForDeduplication tests cover fragments, trailing slashes, www, protocol
- UNIT-02: getResultPriority tests verify open tabs (90) > history (70)
- UNIT-05: isURL tests cover domains, localhost, IPs, and reject search queries
</verification>

<success_criteria>
1. test/unit/url-utilities.test.js exists with 15+ test cases for isURL and normalizeURL
2. test/unit/deduplication.test.js exists with 12+ test cases for normalization and priority
3. All tests pass when running `npm test`
4. Tests use it.each() for table-driven patterns
</success_criteria>

<output>
After completion, create `.planning/phases/02-unit-tests-pure-logic/02-01-SUMMARY.md`
</output>
