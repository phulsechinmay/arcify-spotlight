---
phase: 14-utility-module-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/website-name-extractor.test.js
  - test/unit/popular-sites.test.js
  - test/unit/utils.test.js
autonomous: true

must_haves:
  truths:
    - "website-name-extractor.js has tests covering extractWebsiteName, normalizeHostname, getCuratedName, parseHostnameToName, and singleton export"
    - "popular-sites.js has tests for getAllDomains, getDisplayName, and POPULAR_SITES structure beyond existing findMatchingDomains coverage"
    - "utils.js has tests for getFaviconUrl and getSettings covering all branches"
    - "All new tests pass alongside existing 337+ tests with no regressions"
  artifacts:
    - path: "test/unit/website-name-extractor.test.js"
      provides: "20-30 unit tests for WebsiteNameExtractor class and singleton"
      min_lines: 120
    - path: "test/unit/popular-sites.test.js"
      provides: "10-15 unit tests for getAllDomains, getDisplayName, POPULAR_SITES"
      min_lines: 60
    - path: "test/unit/utils.test.js"
      provides: "8-12 unit tests for getFaviconUrl and getSettings"
      min_lines: 50
  key_links:
    - from: "test/unit/website-name-extractor.test.js"
      to: "shared/website-name-extractor.js"
      via: "import { WebsiteNameExtractor, websiteNameExtractor }"
      pattern: "import.*WebsiteNameExtractor.*from.*website-name-extractor"
    - from: "test/unit/popular-sites.test.js"
      to: "shared/popular-sites.js"
      via: "import { POPULAR_SITES, getAllDomains, getDisplayName }"
      pattern: "import.*getAllDomains.*from.*popular-sites"
    - from: "test/unit/utils.test.js"
      to: "utils.js"
      via: "import { getFaviconUrl, getSettings, Utils }"
      pattern: "import.*getFaviconUrl.*from.*utils"
---

<objective>
Write unit tests for three smaller utility modules: website-name-extractor.js (96 lines, 4% coverage), popular-sites.js (untested exports), and utils.js (31 lines, 13% coverage), targeting 90%+ coverage for each.

Purpose: These three modules have minimal coverage despite being core utilities used across the extension. Website-name-extractor provides display names for all URL results, popular-sites powers domain matching, and utils.js provides settings and favicon helpers.
Output: Three test files with 38-57 total tests covering all exported functions and edge cases.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-utility-module-tests/14-CONTEXT.md
@.planning/phases/14-utility-module-tests/14-RESEARCH.md
@shared/website-name-extractor.js
@shared/popular-sites.js
@utils.js
@test/mocks/chrome.js
@test/setup.js
@test/unit/url-utilities.test.js (pattern reference for it.each style)
@test/unit/fuzzy-matching.test.js (reference for existing popular-sites findMatchingDomains tests -- do NOT duplicate)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write unit tests for WebsiteNameExtractor and utils.js</name>
  <files>test/unit/website-name-extractor.test.js, test/unit/utils.test.js</files>
  <action>
**Create `test/unit/website-name-extractor.test.js`** with 20-30 tests covering all 4 methods + singleton.

WebsiteNameExtractor is a class with pure synchronous methods (no Chrome APIs). It imports from `popular-sites.js` (for POPULAR_SITES lookup) and `logger.js`. Mock logger to prevent side effects:

```javascript
import { describe, it, expect, vi } from 'vitest';

vi.mock('../../logger.js', () => ({
    Logger: { log: vi.fn(), warn: vi.fn(), error: vi.fn() }
}));

import { WebsiteNameExtractor, websiteNameExtractor } from '../../shared/website-name-extractor.js';
```

Create a fresh instance for tests: `const extractor = new WebsiteNameExtractor();`

**describe('WebsiteNameExtractor') tests:**

**normalizeHostname (8-10 tests using it.each):**
- `'https://www.example.com/path'` -> `'example.com'` (strips protocol, www, path)
- `'http://Example.COM'` -> `'example.com'` (lowercases)
- `'example.com'` -> `'example.com'` (no protocol, passes through)
- `'https://sub.example.com'` -> `'sub.example.com'` (preserves subdomains other than www)
- `'www.example.com'` -> `'example.com'` (strips www without protocol)
- `'https://example.com:8080/path?q=1'` -> `'example.com'` (strips port, path, query)
- `'not a valid url at all'` -> fallback extraction (regex match path)
- `''` -> empty or fallback (test actual behavior)

**getCuratedName (4-5 tests):**
- `'github.com'` -> `'GitHub'` (known popular site)
- `'google.com'` -> `'Google'` (known popular site)
- `'unknown-site.com'` -> `null` (unknown domain)
- `'GitHub.com'` -> `null` (case matters -- POPULAR_SITES keys are lowercase)

**parseHostnameToName (6-8 tests using it.each):**
- `'example.com'` -> `'Example'` (strips .com, capitalizes)
- `'my-app.io'` -> `'My-app'` (strips .io)
- `'sub.example.com'` -> `'Example'` (multi-part: takes last before TLD)
- `'cdn.assets.example.com'` -> removes common subdomain prefix, extracts name
- `'example.org'` -> `'Example'` (strips .org)
- `'example.co'` -> `'Example'` (strips .co)
- `null` -> `null` (null input guard)
- `'localhost'` -> `'Localhost'` (no TLD to strip, just capitalize)

**extractWebsiteName (5-6 tests):**
- `'https://github.com'` -> `'GitHub'` (Tier 1: curated match)
- `'https://www.github.com/user/repo'` -> `'GitHub'` (normalizes then curated match)
- `'https://my-random-site.com/page'` -> `'My-random-site'` (Tier 2: hostname parsing)
- `'https://docs.example.com'` -> parsed hostname result (Tier 2 with subdomain)
- `'not-a-url'` -> fallback result (exercises catch/fallback path)

**websiteNameExtractor singleton (2 tests):**
- `websiteNameExtractor` is an instance of WebsiteNameExtractor
- `websiteNameExtractor.extractWebsiteName('https://github.com')` returns `'GitHub'`

---

**Create `test/unit/utils.test.js`** with 8-12 tests covering both exported functions.

utils.js uses `chrome.runtime.getURL` and `chrome.storage.sync.get`, both already in the shared mock.

```javascript
import { describe, it, expect, vi } from 'vitest';
import { chromeMock } from '../mocks/chrome.js';
import { getFaviconUrl, getSettings, Utils } from '../../utils.js';
```

No logger mock needed -- utils.js does not import Logger.

**describe('getFaviconUrl') (4-5 tests):**
- Returns URL containing `/_favicon/` path
- Includes `pageUrl=` parameter with the provided URL
- Defaults to `size=16` when no size argument
- Uses custom size when provided (`getFaviconUrl('https://example.com', '32')` contains `size=32`)
- Uses `chrome.runtime.getURL` to build the base URL

**describe('getSettings') (3-4 tests):**
- Returns settings object from chrome.storage.sync.get
- Passes default settings to chrome.storage.sync.get (enableSpotlight, colorOverrides, debugLoggingEnabled)
- Returns custom settings when storage has overrides (mock returns `{ enableSpotlight: false, debugLoggingEnabled: true }`)

Note: Logger auto-init may call chrome.storage.sync.get before getSettings does. If assertion on call count is needed, use `chromeMock.storage.sync.get.mockClear()` right before the getSettings call within the test, OR assert on the call arguments rather than call count.

**describe('Utils export') (1-2 tests):**
- Utils.getFaviconUrl is the same function as getFaviconUrl
- Utils.getSettings is the same function as getSettings
  </action>
  <verify>
Run `npx vitest run test/unit/website-name-extractor.test.js test/unit/utils.test.js` -- all tests pass. Then run `npx vitest run` -- all tests pass with no regressions.
  </verify>
  <done>
website-name-extractor.test.js has 20-30 passing tests covering normalizeHostname, getCuratedName, parseHostnameToName, extractWebsiteName, and singleton. utils.test.js has 8-12 passing tests covering getFaviconUrl, getSettings, and Utils export. No regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for popular-sites.js untested exports</name>
  <files>test/unit/popular-sites.test.js</files>
  <action>
Create `test/unit/popular-sites.test.js` with 10-15 tests covering the untested exports: `POPULAR_SITES`, `getAllDomains()`, and `getDisplayName()`.

**Important:** `findMatchingDomains` is already tested in `test/unit/fuzzy-matching.test.js` with 8 tests. Do NOT duplicate those tests. Only add edge case tests for findMatchingDomains if there are untested branches.

```javascript
import { describe, it, expect } from 'vitest';
import { POPULAR_SITES, getAllDomains, getDisplayName, findMatchingDomains } from '../../shared/popular-sites.js';
```

No Chrome API mocking needed -- popular-sites.js does not use Chrome APIs directly. It imports FuseSearchService but that is handled by Fuse.js which works in Node.

**describe('POPULAR_SITES') (3-4 tests):**
- Is a non-empty object
- All values are non-empty strings (display names)
- All keys look like domains (contain at least one dot: `key.includes('.')`)
- Contains known entries (spot-check: `POPULAR_SITES['github.com']` === `'GitHub'`, `POPULAR_SITES['google.com']` === `'Google'`)

**describe('getAllDomains') (3-4 tests):**
- Returns an array
- Array length matches `Object.keys(POPULAR_SITES).length`
- Contains known domains ('github.com', 'google.com')
- Every element is a string

**describe('getDisplayName') (4-5 tests):**
- Returns display name for known domain: `getDisplayName('github.com')` -> `'GitHub'`
- Returns display name for another known domain: `getDisplayName('netflix.com')` -> `'Netflix'`
- Returns null for unknown domain: `getDisplayName('unknown-site-xyz.com')` -> `null`
- Returns null for empty string: `getDisplayName('')` -> `null`
- Returns null for undefined: `getDisplayName(undefined)` -> expect null or handle gracefully

**describe('findMatchingDomains - edge cases') (2-3 tests, complement existing):**
Check if these branches are already covered in fuzzy-matching.test.js before adding:
- Returns empty array for null input: `findMatchingDomains(null)` -> `[]`
- Returns empty array for undefined: `findMatchingDomains(undefined)` -> `[]`
- Respects maxResults parameter: `findMatchingDomains('g', 2)` returns at most 2 results

Only add tests that are NOT already in fuzzy-matching.test.js. The existing tests cover: partial match, prefix match, returns matchScore, maxResults limit, exact match, no match for gibberish, and empty string.
  </action>
  <verify>
Run `npx vitest run test/unit/popular-sites.test.js` -- all tests pass. Then run `npx vitest run` -- all tests (existing + new) pass with no regressions. Run `npx vitest run --coverage` and verify popular-sites.js function coverage has increased (getAllDomains and getDisplayName now tested).
  </verify>
  <done>
popular-sites.test.js has 10-15 passing tests covering POPULAR_SITES structure, getAllDomains, getDisplayName, and findMatchingDomains edge cases. Function coverage for popular-sites.js is now near 100%. No regressions in existing fuzzy-matching tests or any other tests.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass (existing + 3 new test files), zero failures
2. `npx vitest run --coverage` -- website-name-extractor.js shows 90%+ line coverage (up from 4%)
3. `npx vitest run --coverage` -- popular-sites.js shows 90%+ function coverage (getAllDomains, getDisplayName now tested)
4. `npx vitest run --coverage` -- utils.js shows 90%+ line coverage (up from 13%)
5. Three new test files exist: website-name-extractor.test.js, popular-sites.test.js, utils.test.js
6. No existing tests broken (particularly fuzzy-matching.test.js which already tests findMatchingDomains)
</verification>

<success_criteria>
- website-name-extractor.js has 90%+ line coverage (up from 4%)
- popular-sites.js has near-100% function coverage (getAllDomains, getDisplayName now covered)
- utils.js has 90%+ line coverage (up from 13%)
- Total new tests: 38-57 across three test files
- All tests pass alongside existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/14-utility-module-tests/14-02-SUMMARY.md`
</output>
