---
phase: 01-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/data-providers/background-data-provider.js
  - shared/data-providers/base-data-provider.js
autonomous: true

must_haves:
  truths:
    - "User sees open tabs in suggestions when input matches tab title"
    - "User sees open tabs in suggestions when input matches tab URL"
    - "Fuzzy matching works (e.g., 'ghub' matches 'GitHub')"
    - "No tab suggestions appear for queries under 2 characters"
    - "Open tabs rank higher than history entries for same match"
  artifacts:
    - path: "shared/data-providers/background-data-provider.js"
      provides: "Fuzzy matching for tab title and URL"
      contains: "getOpenTabsData"
    - path: "shared/data-providers/base-data-provider.js"
      provides: "Fuzzy matching utility function"
      contains: "fuzzyMatch"
  key_links:
    - from: "shared/data-providers/background-data-provider.js"
      to: "base-data-provider.js"
      via: "fuzzyMatch utility function"
      pattern: "fuzzyMatch\\("
---

<objective>
Fix open tab matching so tabs appear in suggestions when user input matches tab title or URL using fuzzy matching.

Purpose: Users currently don't see open tabs in suggestions because the simple `includes()` matching doesn't handle fuzzy queries like "ghub" for "GitHub" or "yt" for "YouTube".

Output: Enhanced tab filtering with fuzzy matching that finds tabs even with abbreviated or partial queries.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/data-providers/background-data-provider.js
@shared/data-providers/base-data-provider.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fuzzy matching utility function</name>
  <files>shared/data-providers/base-data-provider.js</files>
  <action>
Add a simple fuzzy matching function to `BaseDataProvider` class that can be used by subclasses. Add this as a static method or instance method near the other utility methods (around line 430, before `deduplicateResults`).

Implementation approach - use a simple "characters in sequence" fuzzy match:

```javascript
/**
 * Simple fuzzy match - checks if all characters in query appear in text in order
 * Examples: "ghub" matches "GitHub", "yt" matches "YouTube", "gml" matches "Gmail"
 * @param {string} query - The search query (lowercase)
 * @param {string} text - The text to search in (lowercase)
 * @returns {boolean} - True if fuzzy match found
 */
fuzzyMatch(query, text) {
    if (!query || !text) return false;

    const queryLower = query.toLowerCase();
    const textLower = text.toLowerCase();

    // Quick check: if query is contained, it's a match
    if (textLower.includes(queryLower)) {
        return true;
    }

    // Fuzzy match: all query characters must appear in order
    let queryIndex = 0;
    for (let i = 0; i < textLower.length && queryIndex < queryLower.length; i++) {
        if (textLower[i] === queryLower[queryIndex]) {
            queryIndex++;
        }
    }

    return queryIndex === queryLower.length;
}
```

This approach:
- Returns true for exact substring matches (fast path)
- Returns true for "characters in sequence" matches (ghub -> GitHub)
- Is simple, fast, and doesn't require external libraries
- Handles case insensitively
  </action>
  <verify>
Read the base-data-provider.js file and confirm the `fuzzyMatch` method exists and is correctly implemented.
  </verify>
  <done>
Fuzzy matching utility function added to BaseDataProvider class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tab filtering with fuzzy matching and minimum query length</name>
  <files>shared/data-providers/background-data-provider.js</files>
  <action>
Update the `getOpenTabsData()` method (around line 20) to use fuzzy matching and enforce minimum 2-character query per user decision.

Replace the current filtering logic:

```javascript
async getOpenTabsData(query = '') {
    try {
        const tabs = await chrome.tabs.query({});

        const filteredTabs = tabs.filter(tab => {
            if (!tab.title || !tab.url) return false;

            // No query = return all tabs
            if (!query) return true;

            // Minimum 2 characters before matching - user decision to avoid noise
            if (query.length < 2) return false;

            const queryLower = query.toLowerCase();
            const titleLower = tab.title.toLowerCase();
            const urlLower = tab.url.toLowerCase();

            // Use fuzzy matching for both title and URL - user decision
            return this.fuzzyMatch(queryLower, titleLower) ||
                   this.fuzzyMatch(queryLower, urlLower);
        });

        return filteredTabs;
    } catch (error) {
        Logger.error('[BackgroundDataProvider] Error querying tabs:', error);
        return [];
    }
}
```

Key changes:
1. Add minimum 2-character check before matching (per user decision)
2. Replace `includes()` with `this.fuzzyMatch()` for both title and URL
3. The fuzzyMatch method is inherited from BaseDataProvider

Note: `this.fuzzyMatch` works because BackgroundDataProvider extends BaseDataProvider.
  </action>
  <verify>
Manually test in browser:
1. Reload extension
2. Open GitHub in a tab
3. Open spotlight and type "ghub" (2+ chars)
4. **Expected:** GitHub tab appears in suggestions
5. Type "g" (1 char) - **Expected:** No tab suggestions (under minimum)
6. Type "yt" with YouTube open - **Expected:** YouTube tab appears
  </verify>
  <done>
Tab filtering uses fuzzy matching for title and URL. Minimum 2-character query enforced.
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply same fuzzy matching to pinned tab filtering</name>
  <files>shared/data-providers/background-data-provider.js</files>
  <action>
Update the `getPinnedTabsData()` method (around line 104) to use the same fuzzy matching logic for consistency.

Find the query filter section (around line 144-152) and update it:

```javascript
// Apply query filter with fuzzy matching
if (query) {
    // Minimum 2 characters before matching - consistent with open tabs
    if (query.length < 2) {
        Logger.log('[BackgroundDataProvider] Query too short, skipping pinned tab:', bookmark.title);
        continue;
    }

    const queryLower = query.toLowerCase();
    const titleMatch = this.fuzzyMatch(queryLower, bookmark.title.toLowerCase());
    const urlMatch = this.fuzzyMatch(queryLower, bookmark.url.toLowerCase());
    if (!titleMatch && !urlMatch) {
        Logger.log('[BackgroundDataProvider] Bookmark filtered out by query:', bookmark.title);
        continue;
    }
}
```

This ensures pinned tabs (Arcify bookmarks) also benefit from fuzzy matching.
  </action>
  <verify>
Read the getPinnedTabsData method and confirm:
1. Minimum 2-character check is applied
2. fuzzyMatch is used instead of includes()
  </verify>
  <done>
Pinned tab filtering uses same fuzzy matching logic as open tabs.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build the extension: `npm run build`
2. Reload the extension in Chrome
3. Open several tabs: GitHub, YouTube, Gmail, Google Docs
4. Open spotlight and test fuzzy queries:
   - "ghub" should match GitHub
   - "yt" should match YouTube
   - "gml" should match Gmail
   - "gdoc" should match Google Docs
5. Test minimum query length:
   - Single character "g" should NOT show tab suggestions
   - Two characters "gh" SHOULD show matching tabs
6. Verify ranking: open tabs should appear above history entries for same query
</verification>

<success_criteria>
- BUG-02 RESOLVED: Open tabs appear in suggestions when input matches tab title or URL
- Fuzzy matching works for abbreviated queries (ghub, yt, gml)
- Minimum 2-character query enforced (no noise from single chars)
- Both title AND URL are searched for matches
- Matching is case insensitive
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes/01-02-SUMMARY.md`
</output>
