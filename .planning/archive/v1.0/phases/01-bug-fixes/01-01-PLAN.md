---
phase: 01-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/data-providers/base-data-provider.js
autonomous: true

must_haves:
  truths:
    - "User sees no duplicate suggestions when same URL exists in history and open tabs"
    - "Open tab version is shown instead of history when both exist for same URL"
    - "URLs differing only by fragment (#section) are treated as duplicates"
    - "URLs differing only by trailing slash are treated as duplicates"
    - "URLs differing only by www prefix are treated as duplicates"
  artifacts:
    - path: "shared/data-providers/base-data-provider.js"
      provides: "Enhanced URL normalization with fragment removal"
      contains: "normalizeUrlForDeduplication"
  key_links:
    - from: "shared/data-providers/base-data-provider.js"
      to: "deduplicateResults()"
      via: "normalizeUrlForDeduplication called for each result"
      pattern: "normalizeUrlForDeduplication\\(result\\.url\\)"
---

<objective>
Fix URL deduplication to eliminate duplicate suggestions when the same URL exists across multiple sources (history, open tabs, bookmarks).

Purpose: Users currently see the same page appearing multiple times in suggestions because URL normalization doesn't handle all edge cases (fragments, trailing slashes, www prefix variations).

Output: Enhanced `normalizeUrlForDeduplication()` method that correctly identifies duplicate URLs across sources.
</objective>

<execution_context>
@/Users/phulsechinmay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/phulsechinmay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/data-providers/base-data-provider.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance URL normalization for deduplication</name>
  <files>shared/data-providers/base-data-provider.js</files>
  <action>
Update the `normalizeUrlForDeduplication()` method (around line 480) to handle all edge cases per the user's decisions:

1. **Remove URL fragments** - Strip everything after # (including the #)
   - `example.com/page#section` should become `example.com/page`
   - Add this BEFORE other normalizations

2. **Keep query parameters** - Do NOT strip query params (different params = different pages per user decision)
   - `example.com/page?id=1` stays as `example.com/page?id=1`

3. **Existing normalizations to keep:**
   - Remove trailing slashes (already present)
   - Remove http/https protocol (already present)
   - Remove www. prefix (already present)

The updated method should look like:
```javascript
normalizeUrlForDeduplication(url) {
    if (!url) return '';

    let normalizedUrl = url.toLowerCase();

    // Remove URL fragments (anchors) - user decision: ignore fragments
    const fragmentIndex = normalizedUrl.indexOf('#');
    if (fragmentIndex !== -1) {
        normalizedUrl = normalizedUrl.substring(0, fragmentIndex);
    }

    // Remove trailing slashes - user decision: ignore trailing slashes
    normalizedUrl = normalizedUrl.replace(/\/+$/, '');

    // Remove protocol prefixes for comparison (http/https shouldn't matter)
    normalizedUrl = normalizedUrl.replace(/^https?:\/\//, '');

    // Remove www. prefix for comparison - user decision: ignore www prefix
    normalizedUrl = normalizedUrl.replace(/^www\./, '');

    return normalizedUrl;
}
```

NOTE: Query parameters are intentionally kept (not stripped) per user decision that different query params = different pages.
  </action>
  <verify>
Manually test in browser console or via extension:
1. Load extension, open spotlight
2. Search for a URL that exists as open tab AND in history
3. Verify only ONE suggestion appears (the open tab version)
4. Test with URLs containing fragments: `github.com/repo#readme` should dedupe with `github.com/repo`
  </verify>
  <done>
URLs differing only by fragment, trailing slash, www prefix, or protocol are correctly identified as duplicates. Open tab version is shown when duplicate exists in history.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify deduplication priority order</name>
  <files>shared/data-providers/base-data-provider.js</files>
  <action>
Verify that `getResultPriority()` (around line 498) correctly implements the source priority from user decisions:

Priority order (highest to lowest):
1. Open tab (OPEN_TAB: 90)
2. Pinned tab (PINNED_TAB: 85)
3. Bookmark (BOOKMARK: 80)
4. History (HISTORY: 70)

Check the current implementation matches these priorities from `scoring-constants.js`. The current code already uses `BASE_SCORES` which has the correct hierarchy:
- OPEN_TAB: 90
- PINNED_TAB: 85
- BOOKMARK: 80
- HISTORY: 70

If the priorities don't match user decisions (open tab > bookmark > history), update the typePriorities object accordingly. Based on the existing code, the priorities are already correct.

Add a code comment at the top of `getResultPriority()` documenting the priority order:
```javascript
// Get result priority for deduplication (higher = better)
// Priority order: open-tab > pinned-tab > bookmark > history > top-site
// When same URL exists in multiple sources, higher priority source wins
getResultPriority(result) {
```
  </action>
  <verify>
Read the `getResultPriority()` method and confirm:
1. open-tab has highest priority among user content types
2. Priority order matches: open-tab > pinned-tab > bookmark > history
3. Code comment documents the priority order
  </verify>
  <done>
Priority order is documented and confirmed to match user decisions. Open tabs win over history and bookmarks during deduplication.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build the extension: `npm run build`
2. Reload the extension in Chrome
3. Open a URL in a tab (e.g., github.com/some-repo)
4. Wait for it to appear in history (browse around, come back)
5. Open spotlight and search for that URL
6. **Expected:** Only ONE suggestion appears, marked as "open-tab" type
7. Test with fragment URL: Search for URL with #section - should dedupe with non-fragment version
</verification>

<success_criteria>
- BUG-01 RESOLVED: No duplicate suggestions when same URL exists in history and open tabs
- URL normalization handles: fragments, trailing slashes, www prefix, protocol differences
- Query parameters are preserved (different params = different pages)
- Open tab version shown instead of history/bookmark when duplicates exist
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes/01-01-SUMMARY.md`
</output>
