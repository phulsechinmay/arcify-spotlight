const l={URL_SUGGESTION:"url-suggestion",SEARCH_QUERY:"search-query",AUTOCOMPLETE_SUGGESTION:"autocomplete-suggestion",OPEN_TAB:"open-tab",PINNED_TAB:"pinned-tab",BOOKMARK:"bookmark",HISTORY:"history",TOP_SITE:"top-site"},E={CURRENT_TAB:"current-tab",NEW_TAB:"new-tab"};class b{constructor({type:t="",title:r="",url:e="",favicon:o=null,score:i=0,metadata:n={}}={}){this.type=t,this.title=r,this.url=e,this.favicon=o,this.score=i,this.metadata=n,this.domain=this.extractDomain(e)}extractDomain(t){try{if(!t)return"";const r=/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(t)?t:`https://${t}`;return new URL(r).hostname}catch{return t}}}let I=!1,R=!1,U=null;async function L(){if(!R)return U||(U=(async()=>{try{I=(await chrome.storage.sync.get({debugLoggingEnabled:!1})).debugLoggingEnabled||!1,chrome.storage.onChanged.addListener((t,r)=>{r==="sync"&&t.debugLoggingEnabled&&(I=t.debugLoggingEnabled.newValue||!1)}),R=!0}catch(a){console.error("[Logger] Failed to initialize:",a),I=!1,R=!0}})(),U)}function B(){return R?I:(typeof chrome<"u"&&chrome.storage&&!U&&L(),!1)}const s={log:function(...a){B()&&console.log(...a)},error:function(...a){B()&&console.error(...a)},warn:function(...a){B()&&console.warn(...a)},info:function(...a){B()&&console.info(...a)},debug:function(...a){B()&&console.debug(...a)},initialize:L};typeof chrome<"u"&&chrome.storage&&L();class ${constructor(t){if(!t)throw new Error("SearchEngine requires a data provider");this.dataProvider=t,this.cache=new Map,this.suggestionsTimeout=null,this.DEBOUNCE_DELAY=150,this.CACHE_TTL=3e4,this.isBackgroundContext=this.dataProvider.isBackgroundProvider===!0||this.dataProvider.constructor.name==="BackgroundDataProvider"}getSpotlightSuggestionsUsingCache(t,r=E.CURRENT_TAB){return new Promise(e=>{clearTimeout(this.suggestionsTimeout);const o=`${t.trim()}:${r}`,i=this.cache.get(o);if(i&&Date.now()-i.timestamp<this.CACHE_TTL){e(i.results);return}this.suggestionsTimeout=setTimeout(async()=>{try{const n=await this.getSuggestionsImpl(t,r);this.cache.set(o,{results:n,timestamp:Date.now()}),e(n)}catch(n){s.error("Search error:",n),e([])}},this.DEBOUNCE_DELAY)})}async getSpotlightSuggestionsImmediate(t,r=E.CURRENT_TAB){try{return await this.getSuggestionsImpl(t,r)}catch(e){return s.error("[SearchEngine] Immediate suggestions error:",e),s.error("[SearchEngine] Error stack:",e.stack),[]}}async getSuggestionsImpl(t,r){const e=t.trim();return await this.dataProvider.getSpotlightSuggestions(e,r)}async handleResultAction(t,r,e=null){try{switch(t.type){case l.OPEN_TAB:if(r===E.NEW_TAB){if(!t.metadata?.tabId)throw new Error("OPEN_TAB result missing tabId in metadata");if(this.isBackgroundContext)await chrome.tabs.update(t.metadata.tabId,{active:!0}),t.metadata.windowId&&await chrome.windows.update(t.metadata.windowId,{focused:!0});else if(!(await chrome.runtime.sendMessage({action:"switchToTab",tabId:t.metadata.tabId,windowId:t.metadata.windowId}))?.success)throw new Error("Failed to switch tab")}else{if(!t.url)throw new Error("OPEN_TAB result missing URL for current tab navigation");if(this.isBackgroundContext)if(e)await chrome.tabs.update(e,{url:t.url});else{const[i]=await chrome.tabs.query({active:!0,currentWindow:!0});if(i)await chrome.tabs.update(i.id,{url:t.url});else throw new Error("No active tab found")}else if(!(await chrome.runtime.sendMessage({action:"navigateCurrentTab",url:t.url}))?.success)throw new Error("Failed to navigate current tab")}break;case l.PINNED_TAB:if(s.log("[SearchEngine] Handling PINNED_TAB result:",t),!t.metadata?.spaceId)throw new Error("PINNED_TAB result missing spaceId in metadata");const o={action:"activatePinnedTab",spaceId:t.metadata.spaceId,spaceName:t.metadata.spaceName,bookmarkUrl:t.url,mode:r};if(s.log("[SearchEngine] Sending activatePinnedTab message:",o),this.isBackgroundContext)chrome.runtime.sendMessage(o),s.log("[SearchEngine] Message sent from background context");else{const i=await chrome.runtime.sendMessage(o);if(s.log("[SearchEngine] Message sent from content script, response:",i),!i?.success)throw new Error("Failed to activate pinned tab")}break;case l.URL_SUGGESTION:case l.AUTOCOMPLETE_SUGGESTION:case l.BOOKMARK:case l.HISTORY:case l.TOP_SITE:if(!t.url)throw new Error(`${t.type} result missing URL`);if(r===E.NEW_TAB){if(this.isBackgroundContext)await chrome.tabs.create({url:t.url});else if(!(await chrome.runtime.sendMessage({action:"openNewTab",url:t.url}))?.success)throw new Error("Failed to open new tab")}else if(this.isBackgroundContext)if(e)await chrome.tabs.update(e,{url:t.url});else{const[i]=await chrome.tabs.query({active:!0,currentWindow:!0});if(i)await chrome.tabs.update(i.id,{url:t.url});else throw new Error("No active tab found")}else if(!(await chrome.runtime.sendMessage({action:"navigateCurrentTab",url:t.url}))?.success)throw new Error("Failed to navigate current tab");break;case l.SEARCH_QUERY:if(!t.metadata?.query)throw new Error("SEARCH_QUERY result missing query in metadata");if(this.isBackgroundContext){const i=r===E.NEW_TAB?"NEW_TAB":"CURRENT_TAB";await chrome.search.query({text:t.metadata.query,disposition:i})}else if(!(await chrome.runtime.sendMessage({action:"performSearch",query:t.metadata.query,mode:r}))?.success)throw new Error("Failed to perform search");break;default:throw new Error(`Unknown result type: ${t.type}`)}}catch(o){throw s.error("[SearchEngine] Error handling result action:",o),o}}}const S={"google.com":"Google","bing.com":"Bing","duckduckgo.com":"DuckDuckGo","yahoo.com":"Yahoo","chatgpt.com":"ChatGPT","openai.com":"OpenAI","anthropic.com":"Anthropic","claude.ai":"Claude","copilot.microsoft.com":"Copilot","bard.google.com":"Bard","perplexity.ai":"Perplexity","facebook.com":"Facebook","meta.com":"Meta","twitter.com":"Twitter","x.com":"X","linkedin.com":"LinkedIn","instagram.com":"Instagram","tiktok.com":"TikTok","snapchat.com":"Snapchat","pinterest.com":"Pinterest","tumblr.com":"Tumblr","reddit.com":"Reddit","discord.com":"Discord","telegram.org":"Telegram","whatsapp.com":"WhatsApp","signal.org":"Signal","github.com":"GitHub","gitlab.com":"GitLab","bitbucket.org":"Bitbucket","stackoverflow.com":"Stack Overflow","stackexchange.com":"Stack Exchange","codepen.io":"CodePen","jsfiddle.net":"JSFiddle","codesandbox.io":"CodeSandbox","replit.com":"Replit","vercel.com":"Vercel","netlify.com":"Netlify","heroku.com":"Heroku","aws.amazon.com":"AWS","cloud.google.com":"Google Cloud","azure.microsoft.com":"Azure","digitalocean.com":"DigitalOcean","youtube.com":"YouTube","netflix.com":"Netflix","hulu.com":"Hulu","disneyplus.com":"Disney+","primevideo.com":"Prime Video","hbomax.com":"HBO Max","twitch.tv":"Twitch","vimeo.com":"Vimeo","dailymotion.com":"Dailymotion","tiktok.com":"TikTok","spotify.com":"Spotify","apple.com/music":"Apple Music","music.youtube.com":"YouTube Music","soundcloud.com":"SoundCloud","pandora.com":"Pandora","amazon.com":"Amazon","ebay.com":"eBay","etsy.com":"Etsy","walmart.com":"Walmart","target.com":"Target","bestbuy.com":"Best Buy","costco.com":"Costco","alibaba.com":"Alibaba","aliexpress.com":"AliExpress","shopify.com":"Shopify","squarespace.com":"Squarespace","wix.com":"Wix","wordpress.com":"WordPress","cnn.com":"CNN","bbc.com":"BBC","nytimes.com":"New York Times","washingtonpost.com":"Washington Post","theguardian.com":"The Guardian","reuters.com":"Reuters","ap.org":"Associated Press","npr.org":"NPR","foxnews.com":"Fox News","msnbc.com":"MSNBC","bloomberg.com":"Bloomberg","wsj.com":"Wall Street Journal","economist.com":"The Economist","techcrunch.com":"TechCrunch","theverge.com":"The Verge","ars-technica.com":"Ars Technica","microsoft.com":"Microsoft","apple.com":"Apple","adobe.com":"Adobe","salesforce.com":"Salesforce","atlassian.com":"Atlassian","slack.com":"Slack","zoom.us":"Zoom","teams.microsoft.com":"Microsoft Teams","meet.google.com":"Google Meet","notion.so":"Notion","airtable.com":"Airtable","trello.com":"Trello","asana.com":"Asana","monday.com":"Monday.com","dropbox.com":"Dropbox","box.com":"Box","onedrive.live.com":"OneDrive","drive.google.com":"Google Drive","figma.com":"Figma","sketch.com":"Sketch","canva.com":"Canva","behance.net":"Behance","dribbble.com":"Dribbble","unsplash.com":"Unsplash","pexels.com":"Pexels","shutterstock.com":"Shutterstock","gettyimages.com":"Getty Images","paypal.com":"PayPal","venmo.com":"Venmo","stripe.com":"Stripe","square.com":"Square","coinbase.com":"Coinbase","binance.com":"Binance","robinhood.com":"Robinhood","etrade.com":"E*TRADE","fidelity.com":"Fidelity","schwab.com":"Charles Schwab","expedia.com":"Expedia","booking.com":"Booking.com","airbnb.com":"Airbnb","uber.com":"Uber","lyft.com":"Lyft","maps.google.com":"Google Maps","waze.com":"Waze","tripadvisor.com":"TripAdvisor","kayak.com":"Kayak","priceline.com":"Priceline","coursera.org":"Coursera","udemy.com":"Udemy","edx.org":"edX","khanacademy.org":"Khan Academy","duolingo.com":"Duolingo","skillshare.com":"Skillshare","masterclass.com":"MasterClass","pluralsight.com":"Pluralsight","linkedin.com/learning":"LinkedIn Learning","gmail.com":"Gmail","outlook.com":"Outlook","mail.yahoo.com":"Yahoo Mail","protonmail.com":"ProtonMail","tutanota.com":"Tutanota","wikipedia.org":"Wikipedia","wikimedia.org":"Wikimedia","archive.org":"Internet Archive","dictionary.com":"Dictionary.com","merriam-webster.com":"Merriam-Webster","translate.google.com":"Google Translate","deepl.com":"DeepL","steam.com":"Steam","epicgames.com":"Epic Games","battle.net":"Battle.net","xbox.com":"Xbox","playstation.com":"PlayStation","nintendo.com":"Nintendo","roblox.com":"Roblox","minecraft.net":"Minecraft","webmd.com":"WebMD","mayoclinic.org":"Mayo Clinic","healthline.com":"Healthline","fitbit.com":"Fitbit","myfitnesspal.com":"MyFitnessPal","strava.com":"Strava"},G=()=>Object.keys(S),H=(a,t=10)=>{const r=a.toLowerCase(),e=G(),o=[];for(const i of e){const c=i.toLowerCase().split(".")[0];c.startsWith(r)?o.push({domain:i,displayName:S[i],score:100-(c.length-r.length),matchType:"start"}):c.includes(r)?o.push({domain:i,displayName:S[i],score:50,matchType:"contains"}):S[i].toLowerCase().includes(r)&&o.push({domain:i,displayName:S[i],score:30,matchType:"name"})}return o.sort((i,n)=>n.score-i.score).slice(0,t)},d={INSTANT_SEARCH_QUERY:1e3,INSTANT_URL_SUGGESTION:1e3,SEARCH_QUERY:100,URL_SUGGESTION:95,OPEN_TAB:90,PINNED_TAB:85,BOOKMARK:80,HISTORY:70,TOP_SITE:60,FUZZY_MATCH_START:65,FUZZY_MATCH_CONTAINS:63,FUZZY_MATCH_NAME:62,FUZZY_MATCH_DEFAULT:60,AUTOCOMPLETE_SUGGESTION:30},C={EXACT_TITLE_MATCH:20,TITLE_STARTS_WITH:15,TITLE_CONTAINS:10,URL_CONTAINS:5},q=a=>d.AUTOCOMPLETE_SUGGESTION-a,W=(a,t=0,r=0)=>{let e=d.FUZZY_MATCH_DEFAULT;switch(a){case"start":e=d.FUZZY_MATCH_START-(t-r)*.1;break;case"contains":e=d.FUZZY_MATCH_CONTAINS;break;case"name":e=d.FUZZY_MATCH_NAME;break;default:e=d.FUZZY_MATCH_DEFAULT}return Math.max(e,d.FUZZY_MATCH_NAME)};class Y{constructor(){}extractWebsiteName(t){try{const r=this.normalizeHostname(t);if(!r)return t;const e=this.getCuratedName(r);return e||this.parseHostnameToName(r)}catch(r){return s.error("[WebsiteNameExtractor] Error extracting name:",r),this.parseHostnameToName(this.normalizeHostname(t))||t}}normalizeHostname(t){try{const r=/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(t)?t:`https://${t}`;let o=new URL(r).hostname.toLowerCase();return o.startsWith("www.")&&(o=o.substring(4)),o}catch{const r=t.match(/(?:https?:\/\/)?(?:www\.)?([^\/\?#]+)/);return r?r[1].toLowerCase():t}}getCuratedName(t){return S[t]||null}parseHostnameToName(t){if(!t)return null;try{let r=t.replace(/^(www|m|mobile|app|api|cdn|static)\./,"");if(r=r.replace(/\.(com|org|net|edu|gov|mil|int|co|io|ly|me|tv|app|dev|ai)$/,""),r.includes(".")){const e=r.split(".");r=e[e.length-1]}return r.charAt(0).toUpperCase()+r.slice(1)}catch{return t}}}const F=new Y;function Z(a,t="16"){const r=new URL(chrome.runtime.getURL("/_favicon/"));return r.searchParams.set("pageUrl",a),r.searchParams.set("size",t),r.toString()}async function x(){const a={enableSpotlight:!0,colorOverrides:null,debugLoggingEnabled:!1};return await chrome.storage.sync.get(a)}const D={getFaviconUrl:Z,getSettings:x};class k{static normalizeURL(t){return/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(t)?t:`https://${t}`}static isURL(t){try{return new URL(t),!0}catch{}return/^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,63}$/.test(t)||t==="localhost"||t.startsWith("localhost:")?!0:/^(\d{1,3}\.){3}\d{1,3}(:\d+)?$/.test(t)?t.split(":")[0].split(".").every(o=>{const i=parseInt(o,10);return i>=0&&i<=255}):!!/^[a-zA-Z0-9-]+\.(com|org|net|edu|gov|mil|int|co|io|ly|me|tv|app|dev|ai)([/\?#].*)?$/.test(t)}static generateInstantSuggestion(t){const r=t.trim();if(!r)return null;if(k.isURL(r)){const e=k.normalizeURL(r),o=k.extractWebsiteName(e);return{type:l.URL_SUGGESTION,title:o,url:e,score:d.INSTANT_URL_SUGGESTION,metadata:{originalInput:r},domain:"",favicon:null}}else return{type:l.SEARCH_QUERY,title:`Search for "${r}"`,url:"",score:d.INSTANT_SEARCH_QUERY,metadata:{query:r},domain:"",favicon:null}}static escapeHtml(t){const r=document.createElement("div");return r.textContent=t,r.innerHTML}static extractWebsiteName(t){try{return F.extractWebsiteName(t)}catch(r){s.error("[SpotlightUtils] Error extracting website name:",r);try{const e=k.normalizeURL(t);let i=new URL(e).hostname;return i.startsWith("www.")&&(i=i.substring(4)),i.charAt(0).toUpperCase()+i.slice(1)}catch{return t}}}static getFaviconUrl(t){if(t.favicon&&t.favicon.startsWith("http"))return t.favicon;if(t.type===l.AUTOCOMPLETE_SUGGESTION){if(t.metadata?.isUrl&&t.url)try{return D.getFaviconUrl(t.url,"64")}catch{}return`data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>')}`}if(t.url)try{return D.getFaviconUrl(t.url,"64")}catch{}return`data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>')}`}static formatResult(t,r){const e={[l.URL_SUGGESTION]:{title:t.title,subtitle:t.url,action:"↵"},[l.SEARCH_QUERY]:{title:t.title,subtitle:"",action:"↵"},[l.AUTOCOMPLETE_SUGGESTION]:{title:t.title,subtitle:t.metadata?.isUrl?t.url:"",action:"↵"},[l.OPEN_TAB]:{title:t.title,subtitle:t.domain,action:r===E.NEW_TAB?"Switch to Tab":"↵"},[l.PINNED_TAB]:{title:t.title,subtitle:t.domain,action:t.metadata?.isActive?"Switch to Tab":"Open Pinned Tab"},[l.BOOKMARK]:{title:t.title,subtitle:t.domain,action:"↵"},[l.HISTORY]:{title:t.title,subtitle:t.domain,action:"↵"},[l.TOP_SITE]:{title:t.title,subtitle:t.domain,action:"↵"}};return s.log("---- Formatting result type",t.type),e[t.type]||{title:t.title,subtitle:t.url,action:"↵"}}static hexToRgb(t){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return r?`${parseInt(r[1],16)}, ${parseInt(r[2],16)}, ${parseInt(r[3],16)}`:null}static async getAccentColorCSS(t){const r={grey:"204, 204, 204",blue:"139, 179, 243",red:"255, 158, 151",yellow:"255, 226, 159",green:"139, 218, 153",pink:"251, 170, 215",purple:"214, 166, 255",cyan:"165, 226, 234",orange:"255, 176, 103"};let e=r[t]||r.purple;try{const o=await chrome.storage.sync.get(["colorOverrides"]);if(o.colorOverrides&&o.colorOverrides[t]){const i=o.colorOverrides[t],n=this.hexToRgb(i);n&&(e=n)}}catch(o){s.error("Error getting color overrides:",o)}return`
            :root {
                --spotlight-accent-color: rgb(${e});
                --spotlight-accent-color-15: rgba(${e}, 0.15);
                --spotlight-accent-color-20: rgba(${e}, 0.2);
                --spotlight-accent-color-80: rgba(${e}, 0.8);
            }
        `}static areResultsDuplicate(t,r){if(!t||!r)return!1;if(t.url&&r.url){const e=t.url.toLowerCase().replace(/\/+$/,""),o=r.url.toLowerCase().replace(/\/+$/,"");return e===o}return t.type==="search-query"&&r.type==="search-query"?t.title===r.title:!1}static setupFaviconErrorHandling(t){t.querySelectorAll('.arcify-spotlight-result-favicon[data-fallback-icon="true"]').forEach(e=>{e.addEventListener("error",function(){this.src=k.getFaviconUrl({url:null,favicon:null})})})}static formatDebugInfo(t){return""}}class K{constructor(){this.cache=new Map,this.cacheTimeout=5e3}async getOpenTabsData(t=""){throw new Error("getOpenTabsData must be implemented by subclass")}async getRecentTabsData(t=5){throw new Error("getRecentTabsData must be implemented by subclass")}async getBookmarksData(t){throw new Error("getBookmarksData must be implemented by subclass")}async getHistoryData(t){throw new Error("getHistoryData must be implemented by subclass")}async getTopSitesData(){throw new Error("getTopSitesData must be implemented by subclass")}async getAutocompleteData(t){throw new Error("getAutocompleteData must be implemented by subclass")}async getPinnedTabsData(t=""){throw new Error("getPinnedTabsData must be implemented by subclass")}async getSpotlightSuggestions(t,r="current-tab"){const e=t.trim().toLowerCase();if(!e)return this.getDefaultResults(r);try{let o=[],i=[],n=[],c=[],u=[],m=[];try{o=await this.getOpenTabs(e)}catch(p){s.error("[SearchProvider] Failed to get open tabs:",p),o=[]}try{s.log("[BaseDataProvider] Getting pinned tab suggestions for query:",e),i=await this.getPinnedTabSuggestions(e),s.log("[BaseDataProvider] Got pinned tab suggestions:",i.length)}catch(p){s.error("[SearchProvider] Failed to get pinned tabs:",p),i=[]}try{n=await this.getBookmarkSuggestions(e)}catch(p){s.error("[SearchProvider] Failed to get bookmarks:",p),n=[]}try{c=await this.getHistorySuggestions(e)}catch(p){s.error("[SearchProvider] Failed to get history:",p),c=[]}try{u=await this.getTopSites()}catch(p){s.error("[SearchProvider] Failed to get top sites:",p),u=[]}try{m=await this.getAutocompleteSuggestions(e)}catch(p){s.error("[SearchProvider] Failed to get autocomplete:",p),m=[]}const g=[];g.push(...o,...i,...n,...c,...m);const h=this.findMatchingTopSites(u,e);g.push(...h);const w=this.getFuzzyDomainMatches(e);g.push(...w);const f=this.deduplicateResults(g);return this.scoreAndSortResults(f,e)}catch(o){return s.error("[SearchProvider] Search error:",o),[this.generateFallbackResult(e)]}}async getDefaultResults(t){const r=[];try{const e=await this.getOpenTabs("");r.push(...e)}catch(e){s.error("[SearchProvider] Error getting default results:",e)}return this.deduplicateResults(r)}async getOpenTabs(t=""){try{return(await this.getOpenTabsData(t)).map(o=>new b({type:l.OPEN_TAB,title:o.title,url:o.url,favicon:o.favIconUrl,metadata:{tabId:o.id,windowId:o.windowId}}))}catch(r){return s.error("[SearchProvider-Tabs] Error querying tabs:",r),[]}}async getRecentTabs(t=5){try{return(await this.getRecentTabsData(t)).map(o=>new b({type:l.OPEN_TAB,title:o.title,url:o.url,favicon:o.favIconUrl,metadata:{tabId:o.id,windowId:o.windowId}}))}catch(r){return s.error("[SearchProvider-Tabs] Error getting recent tabs:",r),[]}}async getPinnedTabSuggestions(t){try{s.log("[BaseDataProvider] getPinnedTabSuggestions called with query:",t);const r=await this.getPinnedTabsData(t);s.log("[BaseDataProvider] Got pinned tabs data:",r.length,r);const e=r.map(o=>{const i=new b({type:l.PINNED_TAB,title:o.title,url:o.url,metadata:{bookmarkId:o.id,spaceId:o.spaceId,spaceName:o.spaceName,spaceColor:o.spaceColor,tabId:o.tabId,isActive:o.isActive}});return s.log("[BaseDataProvider] Created PINNED_TAB SearchResult:",i),i});return s.log("[BaseDataProvider] Returning",e.length,"pinned tab results"),e}catch(r){return s.error("[SearchProvider-PinnedTabs] Error getting pinned tab suggestions:",r),[]}}async getBookmarkSuggestions(t){try{return(await this.getBookmarksData(t)).map(o=>new b({type:l.BOOKMARK,title:o.title,url:o.url,metadata:{bookmarkId:o.id}}))}catch(r){return s.error("[SearchProvider-Bookmarks] Error getting bookmark suggestions:",r),[]}}async getHistorySuggestions(t){try{return(await this.getHistoryData(t)).map(o=>new b({type:l.HISTORY,title:o.title||o.url,url:o.url,metadata:{visitCount:o.visitCount,lastVisitTime:o.lastVisitTime}}))}catch(r){return s.error("[SearchProvider-History] Error getting history suggestions:",r),[]}}async getTopSites(){try{return(await this.getTopSitesData()).map(e=>new b({type:l.TOP_SITE,title:e.title,url:e.url}))}catch(t){return s.error("[SearchProvider-TopSites] Error getting top sites:",t),[]}}async getAutocompleteSuggestions(t){try{return await this.getAutocompleteData(t)}catch(r){return s.error("[SearchProvider-Autocomplete] Error getting autocomplete suggestions:",r),[]}}generateURLSuggestion(t){const r=/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(t)?t:`https://${t}`;return new b({type:l.URL_SUGGESTION,title:`Navigate to ${r}`,url:r,score:95})}generateSearchSuggestion(t){return new b({type:l.SEARCH_QUERY,title:`Search for "${t}"`,url:"",score:80,metadata:{query:t}})}generateFallbackResult(t){return k.isURL(t)?this.generateURLSuggestion(t):this.generateSearchSuggestion(t)}scoreAndSortResults(t,r){return t.forEach(o=>{o.score=this.calculateRelevanceScore(o,r)}),t.sort((o,i)=>i.score-o.score).slice(0,8)}calculateRelevanceScore(t,r){if(t.metadata?.fuzzyMatch)return t.score;let e=0;switch(t.type){case l.SEARCH_QUERY:e=d.SEARCH_QUERY;break;case l.URL_SUGGESTION:e=d.URL_SUGGESTION;break;case l.OPEN_TAB:e=d.OPEN_TAB;break;case l.PINNED_TAB:e=d.PINNED_TAB;break;case l.BOOKMARK:e=d.BOOKMARK;break;case l.HISTORY:e=d.HISTORY;break;case l.TOP_SITE:e=d.TOP_SITE;break;case l.AUTOCOMPLETE_SUGGESTION:e=d.AUTOCOMPLETE_SUGGESTION;break}const o=r.toLowerCase(),i=t.title.toLowerCase(),n=t.url.toLowerCase();return i===o?e+=C.EXACT_TITLE_MATCH:i.startsWith(o)?e+=C.TITLE_STARTS_WITH:i.includes(o)&&(e+=C.TITLE_CONTAINS),n.includes(o)&&(e+=C.URL_CONTAINS),Math.max(0,e)}findMatchingTopSites(t,r){const e=r.toLowerCase();return t.filter(o=>{const i=o.title.toLowerCase(),n=o.url.toLowerCase();if(i.includes(e)||n.includes(e))return!0;try{let u=new URL(o.url).hostname.toLowerCase();if(u.startsWith("www.")&&(u=u.substring(4)),u.split(".")[0].startsWith(e))return!0}catch{}return!1})}getFuzzyDomainMatches(t){return H(t,5).map(e=>{const o=W(e.matchType,e.domain.length,t.length);return new b({type:l.TOP_SITE,title:e.displayName,url:`https://${e.domain}`,score:o,metadata:{fuzzyMatch:!0,matchType:e.matchType,originalQuery:t}})})}fuzzyMatch(t,r){if(!t||!r)return!1;const e=t.toLowerCase(),o=r.toLowerCase();if(o.includes(e))return!0;let i=0;for(let n=0;n<o.length&&i<e.length;n++)o[n]===e[i]&&i++;return i===e.length}deduplicateResults(t){const r=new Map,e=[];for(const o of t){let i="";if(o.url?i=this.normalizeUrlForDeduplication(o.url):o.type==="search-query"?i=`search:${o.title}`:i=o.title||"",!i)continue;const n=r.get(i);if(!n)r.set(i,o),e.push(o);else{const c=this.getResultPriority(n);if(this.getResultPriority(o)>c){const m=e.indexOf(n);m!==-1&&(e[m]=o,r.set(i,o))}}}return e}normalizeUrlForDeduplication(t){if(!t)return"";let r=t.toLowerCase();const e=r.indexOf("#");return e!==-1&&(r=r.substring(0,e)),r=r.replace(/\/+$/,""),r=r.replace(/^https?:\/\//,""),r=r.replace(/^www\./,""),r}getResultPriority(t){const e={"open-tab":d.OPEN_TAB,"pinned-tab":d.PINNED_TAB,bookmark:d.BOOKMARK,history:d.HISTORY,"top-site":t.metadata?.fuzzyMatch?d.FUZZY_MATCH_START:d.TOP_SITE,"autocomplete-suggestion":d.AUTOCOMPLETE_SUGGESTION,"search-query":d.SEARCH_QUERY,"url-suggestion":d.URL_SUGGESTION}[t.type]||0,o=t.score||0;return e+o}}class Q{constructor(){this.cache=new Map,this.pendingRequests=new Map,this.CACHE_TTL=3e4,this.REQUEST_TIMEOUT=3e3}async getAutocompleteSuggestions(t){const r=t.trim();if(!r||r.length<2)return[];const e=r.toLowerCase(),o=this.cache.get(e);if(o&&Date.now()-o.timestamp<this.CACHE_TTL)return o.results;if(this.pendingRequests.has(e))return await this.pendingRequests.get(e);const i=this.fetchAutocompleteSuggestions(r);this.pendingRequests.set(e,i);try{const n=await i;return this.cache.set(e,{results:n,timestamp:Date.now()}),n}catch(n){return s.error("[AutocompleteProvider] Error fetching suggestions:",n),[]}finally{this.pendingRequests.delete(e)}}async fetchAutocompleteSuggestions(t){try{const r=`https://clients1.google.com/complete/search?client=firefox&q=${encodeURIComponent(t)}`,e=new AbortController,o=setTimeout(()=>e.abort(),this.REQUEST_TIMEOUT),i=await fetch(r,{method:"GET",signal:e.signal,headers:{Accept:"application/json","User-Agent":"Mozilla/5.0 (compatible; Arcify)"}});if(clearTimeout(o),!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const n=await i.json();return!Array.isArray(n)||n.length<2||!Array.isArray(n[1])?(s.warn("[AutocompleteProvider] Unexpected response format:",n),[]):n[1].slice(0,5).map((m,g)=>{const h=k.isURL(m);return new b({type:l.AUTOCOMPLETE_SUGGESTION,title:h?this.extractWebsiteName(m):m,url:h?this.normalizeURL(m):`https://www.google.com/search?q=${encodeURIComponent(m)}`,score:q(g),favicon:null,metadata:{query:m,originalQuery:t,position:g,isUrl:h}})})}catch(r){return r.name==="AbortError"?s.warn("[AutocompleteProvider] Request timeout"):s.error("[AutocompleteProvider] Fetch error:",r),[]}}normalizeURL(t){return/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(t)?t:`https://${t}`}extractWebsiteName(t){try{return F.extractWebsiteName(t)}catch(r){s.error("[AutocompleteProvider] Error extracting website name:",r);try{const e=this.normalizeURL(t);let i=new URL(e).hostname;return i.startsWith("www.")&&(i=i.substring(4)),i.charAt(0).toUpperCase()+i.slice(1)}catch{return t}}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}getCacheStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size,cacheEntries:Array.from(this.cache.keys())}}}const P={async findArcifyFolder(){s.log("[BookmarkUtils] Finding Arcify folder...");try{s.log("[BookmarkUtils] Method 1: Searching for Arcify folder by title...");const a=await chrome.bookmarks.search({title:"Arcify"});if(a&&a.length>0){const e=a.find(o=>!o.url);if(e)return s.log("[BookmarkUtils] Found Arcify folder via search:",e.id),e}s.log("[BookmarkUtils] Method 1 failed, trying Method 2: Traversing bookmark tree...");const t=await chrome.bookmarks.getChildren("0");s.log("[BookmarkUtils] Root folders found:",t.map(e=>({id:e.id,title:e.title})));for(const e of t){s.log(`[BookmarkUtils] Checking folder: ${e.title} (ID: ${e.id})`);try{const i=(await chrome.bookmarks.getChildren(e.id)).find(n=>n.title==="Arcify"&&!n.url);if(i)return s.log(`[BookmarkUtils] Found Arcify folder in ${e.title}:`,i.id),i}catch(o){s.warn(`[BookmarkUtils] Error checking folder ${e.title}:`,o);continue}}s.log("[BookmarkUtils] Method 2 failed, trying Method 3: Check Other Bookmarks specifically...");const r=t.find(e=>e.id==="2"||e.title.toLowerCase().includes("other")||e.title.toLowerCase().includes("bookmark"));if(r){s.log(`[BookmarkUtils] Found Other Bookmarks folder: ${r.title} (ID: ${r.id})`);try{const o=(await chrome.bookmarks.getChildren(r.id)).find(i=>i.title==="Arcify"&&!i.url);if(o)return s.log("[BookmarkUtils] Found Arcify folder in Other Bookmarks:",o.id),o}catch(e){s.warn("[BookmarkUtils] Error checking Other Bookmarks folder:",e)}}return s.log("[BookmarkUtils] All methods failed - Arcify folder not found"),null}catch(a){return s.error("[BookmarkUtils] Error in findArcifyFolder:",a),null}},async getBookmarksFromFolderRecursive(a,t={}){const{includeTabIds:r=!1,groupId:e=null}=t,o=[],i=await chrome.bookmarks.getChildren(a);let n=[];r&&e!==null&&(n=await chrome.tabs.query({groupId:e}));for(const c of i)if(c.url){const u={id:c.id,title:c.title,url:c.url};if(r&&n.length>0){const m=n.find(g=>g.url===c.url);m&&(u.tabId=m.id)}o.push(u)}else{const u=await this.getBookmarksFromFolderRecursive(c.id,t);o.push(...u)}return o},async findBookmarkInFolderRecursive(a,t){const{url:r,title:e}=t,o=r?`URL: ${r}`:e?`title: ${e}`:"unknown criteria";if(s.log(`[BookmarkUtils] Searching for bookmark with ${o} in folder: ${a}`),!a||!r&&!e)return s.warn("[BookmarkUtils] Missing folderId or search criteria (url/title) for recursive search"),null;try{const i=await chrome.bookmarks.getChildren(a);s.log(`[BookmarkUtils] Found ${i.length} items in folder ${a}`);for(const n of i)if(n.url){let c=!1;if(r&&n.url===r&&(c=!0),e&&n.title===e&&(c=!0),c)return s.log(`[BookmarkUtils] Found matching bookmark: ${n.title} in folder ${a}`),{bookmark:n,parentFolderId:a,folderPath:a}}else{s.log(`[BookmarkUtils] Recursing into subfolder: ${n.title} (${n.id})`);const c=await this.findBookmarkInFolderRecursive(n.id,t);if(c)return s.log(`[BookmarkUtils] Found bookmark in subfolder: ${n.title}`),c}return s.log(`[BookmarkUtils] Bookmark not found in folder ${a}`),null}catch(i){return s.error(`[BookmarkUtils] Error searching folder ${a}:`,i),null}},findBookmarkByUrl(a,t){return!a||!t?null:a.find(r=>r.url?r.url===t:!1)||null},findTabByUrl(a,t){return!a||!t?null:a.find(r=>r.url?r.url===t:!1)||null},async openBookmarkAsTab(a,t,r=null,e,o){const{spaces:i,activeSpaceId:n,currentWindow:c,saveSpaces:u,createTabElement:m,activateTabInDOM:g,Utils:h,reconcileSpaceTabOrdering:w}=e;s.log("[BookmarkUtils] Opening bookmark as tab:",a.url,t);const f=await chrome.tabs.create({url:a.url,active:!0,windowId:c.id});if(a.title&&f.title!==a.title&&await h.setTabNameOverride(f.id,a.url,a.title),await chrome.tabs.group({tabIds:[f.id],groupId:t}),o){const y=i.find(p=>p.id===t);y&&(y.spaceBookmarks.includes(f.id)||y.spaceBookmarks.push(f.id),u()),h&&typeof h.setPinnedTabState=="function"&&await h.setPinnedTabState(f.id,{pinnedUrl:a.url,bookmarkId:a.bookmarkId||null})}if(typeof w=="function"&&await w(t,{source:"arcify",movedTabId:f.id}),r&&m){const y={id:f.id,title:a.title,url:a.url,favIconUrl:f.favIconUrl,spaceName:a.spaceName,pinnedUrl:a.url,bookmarkId:a.bookmarkId||null},p=await m(y,!0,!1);p.classList.add("active"),r.replaceWith(p)}return await chrome.tabs.update(f.id,{active:!0}),g&&g(f.id),s.log("[BookmarkUtils] Successfully opened bookmark as tab:",f.id),f},async removeBookmarkByUrl(a,t,r={}){const{removeTabElement:e=!1,tabElement:o=null,logRemoval:i=!1}=r,n=await chrome.bookmarks.getChildren(a);for(const c of n){if(c.url===t)return i&&s.log("[BookmarkUtils] Removing bookmark:",c),await chrome.bookmarks.remove(c.id),e&&o&&o.remove(),!0;if(!c.url&&await this.removeBookmarkByUrl(c.id,t,r))return!0}return!1},async matchTabsWithBookmarks(a,t,r=null){const e=[],o=await chrome.bookmarks.getChildren(a.id),i=await chrome.tabs.query({groupId:t});for(const n of o)if(n.url){const c=i.find(u=>u.url===n.url);c&&(e.push(c.id),n.title&&n.title!==c.title&&r&&(await r(c.id,c.url,n.title),s.log(`[BookmarkUtils] Override set for tab ${c.id} from bookmark: ${n.title}`)))}else{const c=await this.matchTabsWithBookmarks(n,t,r);e.push(...c)}return e},async updateBookmarkTitle(a,t,r){s.log(`[BookmarkUtils] Attempting to update bookmark for tab ${a.id} in space ${t.name} to title: ${r}`);try{const e=await this.findArcifyFolder();if(!e)return s.error(`[BookmarkUtils] Arcify folder not found for space ${t.name}.`),!1;const i=(await chrome.bookmarks.getChildren(e.id)).find(u=>u.title===t.name&&!u.url);if(!i)return s.error(`[BookmarkUtils] Space folder ${t.name} not found.`),!1;const n=async u=>{const m=await chrome.bookmarks.getChildren(u);for(const g of m){if(g.url&&g.url===a.url)return g.title!==r?(s.log(`[BookmarkUtils] Found bookmark ${g.id} for URL ${a.url}. Updating title to "${r}"`),await chrome.bookmarks.update(g.id,{title:r})):s.log(`[BookmarkUtils] Bookmark ${g.id} title already matches "${r}". Skipping update.`),!0;if(!g.url&&await n(g.id))return!0}return!1},c=await n(i.id);return c||s.log(`[BookmarkUtils] Bookmark for URL ${a.url} not found in space folder ${t.name}.`),c}catch(e){return s.error(`[BookmarkUtils] Error updating bookmark for tab ${a.id}:`,e),!1}},isUnderArcifyFolder(a,t){return a.parentId&&(a.parentId===t||a.parentId.startsWith(t))},async getBookmarksData(a){try{const t=await chrome.bookmarks.search(a);let r=null;try{const o=await this.findArcifyFolder();o&&(r=o.id)}catch{}return t.filter(o=>!(!o.url||r&&this.isUnderArcifyFolder(o,r)))}catch(t){return s.error("[BookmarkUtils] Error getting bookmarks:",t),[]}}},M="tabLastActivity";class j extends K{constructor(){super(),this.autocompleteProvider=new Q,this.isBackgroundProvider=!0}async getOpenTabsData(t=""){try{return(await chrome.tabs.query({})).filter(o=>{if(!o.title||!o.url)return!1;if(!t)return!0;if(t.length<2)return!1;const i=t.toLowerCase(),n=o.title.toLowerCase(),c=o.url.toLowerCase();return this.fuzzyMatch(i,n)||this.fuzzyMatch(i,c)})}catch(r){return s.error("[BackgroundDataProvider] Error querying tabs:",r),[]}}async getRecentTabsData(t=5){try{const r=await chrome.tabs.query({}),o=(await chrome.storage.local.get([M]))[M]||{};return r.filter(n=>n.url&&n.title).map(n=>({...n,lastActivity:o[n.id]||0})).sort((n,c)=>(c.lastActivity||0)-(n.lastActivity||0)).slice(0,t)}catch(r){return s.error("[BackgroundDataProvider] Error getting recent tabs:",r),[]}}async getBookmarksData(t){return await P.getBookmarksData(t)}isUnderArcifyFolder(t,r){return t.parentId&&(t.parentId===r||t.parentId.startsWith(r))}async getHistoryData(t){try{return await chrome.history.search({text:t,maxResults:10,startTime:Date.now()-6048e5})}catch(r){return s.error("[BackgroundDataProvider] Error getting history:",r),[]}}async getTopSitesData(){try{return await chrome.topSites.get()}catch(t){return s.error("[BackgroundDataProvider] Error getting top sites:",t),[]}}async getAutocompleteData(t){try{return await this.autocompleteProvider.getAutocompleteSuggestions(t)}catch(r){return s.error("[BackgroundDataProvider] Error getting autocomplete data:",r),[]}}async getPinnedTabsData(t=""){s.log("[BackgroundDataProvider] getPinnedTabsData called with query:",t);try{const e=(await chrome.storage.local.get("spaces")).spaces||[];s.log("[BackgroundDataProvider] Found spaces:",e.length,e.map(u=>u.name));const o=await chrome.tabs.query({});s.log("[BackgroundDataProvider] Found tabs:",o.length);const i=await P.findArcifyFolder();if(!i)return s.log("[BackgroundDataProvider] No Arcify folder found"),[];s.log("[BackgroundDataProvider] Found Arcify folder:",i.id);const n=await chrome.bookmarks.getChildren(i.id);s.log("[BackgroundDataProvider] Found space folders:",n.length,n.map(u=>u.title));const c=[];for(const u of n){const m=e.find(h=>h.name===u.title);if(s.log("[BackgroundDataProvider] Processing space folder:",u.title,"found space:",!!m),!m)continue;const g=await P.getBookmarksFromFolderRecursive(u.id);s.log("[BackgroundDataProvider] Found bookmarks in",u.title,":",g.length);for(const h of g){const w=P.findTabByUrl(o,h.url);if(s.log("[BackgroundDataProvider] Processing bookmark:",h.title,"matching tab:",!!w),t){if(t.length<2){s.log("[BackgroundDataProvider] Query too short, skipping pinned tab:",h.title);continue}const y=t.toLowerCase(),p=this.fuzzyMatch(y,h.title.toLowerCase()),z=this.fuzzyMatch(y,h.url.toLowerCase());if(!p&&!z){s.log("[BackgroundDataProvider] Bookmark filtered out by query:",h.title);continue}}const f={...h,spaceId:m.id,spaceName:m.name,spaceColor:m.color,tabId:w?.id||null,isActive:!!w};s.log("[BackgroundDataProvider] Adding pinned tab:",f),c.push(f)}}return s.log("[BackgroundDataProvider] Returning",c.length,"pinned tabs"),c}catch(r){return s.error("[BackgroundDataProvider] Error getting pinned tabs data:",r),[]}}}const A={CURRENT_TAB:"current-tab",NEW_TAB:"new-tab"},v=new $(new j),T=new Set;async function _(){try{const a=Array.from(T).map(t=>chrome.tabs.sendMessage(t,{action:"closeSpotlight"}).catch(()=>{T.delete(t)}));await Promise.all(a),T.clear()}catch(a){s.error("[Background] Error closing spotlight in tracked tabs:",a)}}function V(a){if(!a)return!1;const t=[/^chrome:\/\//,/^chrome-extension:\/\//,/^edge:\/\//,/^about:/,/^moz-extension:\/\//,/^vivaldi:\/\//,/^brave:\/\//,/^opera:\/\//];for(const r of t)if(r.test(a))return!1;return!0}async function N(a){try{if(!(await x()).enableSpotlight){if(s.log("Spotlight is disabled in settings."),a===A.NEW_TAB){s.log("Opening default new tab instead of spotlight new tab.");try{await chrome.tabs.create({url:"chrome://new-tab-page/"})}catch{await chrome.tabs.create({url:"chrome-search://local-ntp/local-ntp.html"})}}else s.log("Aborting spotlight injection.");return}await _();const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(r){if(!V(r.url)){s.log("Tab URL doesn't support content scripts, opening custom new tab directly:",r.url),await O(a);return}try{const e=await chrome.tabs.sendMessage(r.id,{action:"activateSpotlight",mode:a,tabUrl:r.url,tabId:r.id});if(e&&e.success){chrome.runtime.sendMessage({action:"spotlightOpened",mode:a});return}}catch(e){s.log("Content script messaging failed, using new tab fallback:",e),await O(a);return}}}catch(t){s.log("All spotlight activation methods failed, using Chrome tab fallback:",t),await O(a)}}async function O(a){try{await _(),s.log(`Falling back to custom new tab page for mode: ${a}`),await chrome.tabs.create({url:chrome.runtime.getURL("newtab.html"),active:!0}),s.log("Spotlight failed - opened custom new tab with spotlight interface")}catch(t){s.error("Error with Chrome tab fallback:",t)}}chrome.commands.onCommand.addListener(async function(a){a==="toggleSpotlight"?await N(A.CURRENT_TAB):a==="toggleSpotlightNewTab"&&await N(A.NEW_TAB)});chrome.runtime.onMessage.addListener(async function(a,t,r){a.command==="toggleSpotlight"?await N(A.CURRENT_TAB):a.command==="toggleSpotlightNewTab"&&await N(A.NEW_TAB)});chrome.tabs.onActivated.addListener(async a=>{await _()});chrome.tabs.onRemoved.addListener(async(a,t)=>{T.has(a)&&T.delete(a)});chrome.runtime.onMessage.addListener((a,t,r)=>a.action==="openNewTab"?(chrome.tabs.create({url:a.url}),r({success:!0}),!1):a.action==="navigateToDefaultNewTab"?((async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e&&e.url&&e.url.includes("newtab.html"))try{await chrome.tabs.update(e.id,{url:"chrome://new-tab-page/"})}catch{await chrome.tabs.update(e.id,{url:"chrome-search://local-ntp/local-ntp.html"})}r({success:!0})}catch(e){s.error("[Background] Error navigating to default new tab:",e),r({success:!1,error:e.message})}})(),!0):a.action==="switchToTab"?((async()=>{try{await chrome.tabs.update(a.tabId,{active:!0}),await chrome.windows.update(a.windowId,{focused:!0}),r({success:!0})}catch(e){s.error("[Background] Error switching to tab:",e),r({success:!1,error:e.message})}})(),!0):a.action==="navigateCurrentTab"?((async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e&&await chrome.tabs.update(e.id,{url:a.url}),r({success:!0})}catch(e){s.error("[Background] Error navigating current tab:",e),r({success:!1,error:e.message})}})(),!0):a.action==="searchTabs"?((async()=>{try{const e=await chrome.tabs.query({}),o=a.query?.toLowerCase()||"",i=e.filter(n=>!n.title||!n.url?!1:o?n.title.toLowerCase().includes(o)||n.url.toLowerCase().includes(o):!0);r({success:!0,tabs:i})}catch(e){s.error("[Background] Error searching tabs:",e),r({success:!1,error:e.message})}})(),!0):a.action==="searchBookmarks"?((async()=>{try{const o=(await chrome.bookmarks.search(a.query)).filter(i=>i.url);r({success:!0,bookmarks:o})}catch(e){s.error("[Background] Error searching bookmarks:",e),r({success:!1,error:e.message})}})(),!0):a.action==="searchHistory"?((async()=>{try{const e=await chrome.history.search({text:a.query,maxResults:10,startTime:Date.now()-6048e5});r({success:!0,history:e})}catch(e){s.error("[Background] Error searching history:",e),r({success:!1,error:e.message})}})(),!0):a.action==="getTopSites"?((async()=>{try{const e=await chrome.topSites.get();r({success:!0,topSites:e})}catch(e){s.error("[Background] Error getting top sites:",e),r({success:!1,error:e.message})}})(),!0):a.action==="getAutocomplete"?((async()=>{try{const o=await v.dataProvider.getAutocompleteData(a.query);r({success:!0,suggestions:o})}catch(e){s.error("[Background] Error getting autocomplete suggestions:",e),r({success:!1,error:e.message,suggestions:[]})}})(),!0):a.action==="getPinnedTabs"?(s.log("[Background] Received getPinnedTabs message:",a),(async()=>{try{const e=v.dataProvider;s.log("[Background] Getting pinned tabs from data provider...");const o=await e.getPinnedTabsData(a.query);s.log("[Background] Sending pinned tabs response:",o.length,"tabs"),r({success:!0,pinnedTabs:o})}catch(e){s.error("[Background] Error getting pinned tabs:",e),r({success:!1,error:e.message,pinnedTabs:[]})}})(),!0):a.action==="getActiveSpaceColor"?((async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.groupId||e.groupId===chrome.tabGroups.TAB_GROUP_ID_NONE){r({success:!0,color:"purple"});return}try{const o=await chrome.tabGroups.get(e.groupId);r({success:!0,color:o.color||"purple"})}catch(o){s.error("[Background] Error fetching tab group:",o),r({success:!0,color:"purple"})}}catch(e){s.error("[Background] Error getting active space color:",e),r({success:!1,error:e.message,color:"purple"})}})(),!0):a.action==="performSearch"?((async()=>{try{const e=a.mode===A.NEW_TAB?"NEW_TAB":"CURRENT_TAB";await chrome.search.query({text:a.query,disposition:e}),r({success:!0})}catch(e){s.error("[Background] Error performing search:",e),r({success:!1,error:e.message})}})(),!0):a.action==="getSpotlightSuggestions"?((async()=>{try{const e=a.query.trim(),o=e?await v.getSpotlightSuggestionsUsingCache(e,a.mode):await v.getSpotlightSuggestionsImmediate("",a.mode);r({success:!0,results:o})}catch(e){s.error("[Background] Error getting spotlight suggestions:",e),r({success:!1,error:e.message,results:[]})}})(),!0):a.action==="spotlightHandleResult"?((async()=>{try{if(!a.result||!a.result.type||!a.mode)throw new Error("Invalid spotlight result message");const e=t.tab&&t.tab.id?t.tab.id:a.tabId;await v.handleResultAction(a.result,a.mode,e),r({success:!0})}catch(e){s.error("[Background] Error handling spotlight result:",e),r({success:!1,error:e.message})}})(),!0):a.action==="spotlightOpened"?(t.tab&&t.tab.id&&T.add(t.tab.id),!1):a.action==="spotlightClosed"?(t.tab&&t.tab.id&&T.delete(t.tab.id),!1):(a.action==="activatePinnedTab"&&(chrome.runtime.sendMessage(a),r({success:!0})),!1));
